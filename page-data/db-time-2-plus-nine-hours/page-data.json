{"componentChunkName":"component---src-templates-post-jsx","path":"/db-time-2-plus-nine-hours/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"7b08be9d-63ad-5aff-b0cb-1e873d8148ec","excerpt":"이 글은 우테코 달록팀 크루 파랑이 작성했습니다. 문제 상황  어느날 실제 배포 서버의 DB를 확인해보았는데 start/end date time이 전부 +9시간되어 저장된 것을 확인했다.  분명 서비스에서는 00시 00분으로 잘 나오는데 왜 DB에만 9시간이 더해져서 저장되는 걸까? 원인 찾기 가정 1. MySQL Server timezone이 UTC여서…","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 <a href=\"https://github.com/summerlunaa\">파랑</a>이 작성했습니다.</p>\n</blockquote>\n<h2>문제 상황</h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/f6ae2a0b6c09d297b98ee1470abc7938/c62b2/dallog_schedules.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1ElEQVQY012OWQ6CQBBEuYP7EndRFMUF0EFWN0SIURPjj/e/RtnTxsT4Uenpmpo3pbQsH32xRX3uoDYTPNt2gB55qrNHZxWiaqw5I3fpl6crNE2P9wqdK3T/ldJdRxi6B1QJVprYHJaPjW2GcXDCJDrT/RF6kJCXQg8T9tTNnjUgSUaPpDo7KJoXUyCFscu4WU5bMMi9PGHGV4jsATu5w4pv7C0OF0T3F8OKukXtBZf4NlVG/hEiuXKgsXSRH5voEFiCrNMNIv0AZ/ShBBo/s0DZf70BfiqCz3cgZP0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='달록 캡쳐' title='달록 캡쳐' src='/static/f6ae2a0b6c09d297b98ee1470abc7938/ca1dc/dallog_schedules.png' srcset='/static/f6ae2a0b6c09d297b98ee1470abc7938/e7570/dallog_schedules.png 170w,\n/static/f6ae2a0b6c09d297b98ee1470abc7938/f46e7/dallog_schedules.png 340w,\n/static/f6ae2a0b6c09d297b98ee1470abc7938/ca1dc/dallog_schedules.png 680w,\n/static/f6ae2a0b6c09d297b98ee1470abc7938/c62b2/dallog_schedules.png 712w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>달록 캡쳐</figcaption>\n  </figure></p>\n<p>어느날 실제 배포 서버의 DB를 확인해보았는데 start/end date time이 전부 +9시간되어 저장된 것을 확인했다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 374px; '>\n      <a class='gatsby-resp-image-link' href='/static/129502a52ce79743e4bb1058133e22e0/b0af8/nine_birthday.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8ElEQVQoz5WRzWrDMBCE/f7P01OPhVD6k6aFnJMSx7Jky7ZiybVs1Z6uBCqkl1QDC4JdvtkdZcuyYJ4dnP3CaC4YrYWUDZxz8FrX9V8VlVkCMC6gKg5+Oob3y3ZHJjNSFMFZpGszoKbN+l5DNg1EVaOqJUoy4KKiEpjIRBsDVvIw4/t+zi8Vob/Aw/ETm8cnvL69Y7v7QH5mAXIuGApWhjLDgLbrqFcEkAd7w3H8A1xWBOembcm1RqcUUhUXy25lkvIpYcNOWdzd55SJpLNPyPcPUC2/gqYo6/WMzbOA1ppyocwOe0zT99UZScBbmaTqB63VvaYufBxjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='나인 생일' title='나인 생일' src='/static/129502a52ce79743e4bb1058133e22e0/b0af8/nine_birthday.png' srcset='/static/129502a52ce79743e4bb1058133e22e0/e7570/nine_birthday.png 170w,\n/static/129502a52ce79743e4bb1058133e22e0/f46e7/nine_birthday.png 340w,\n/static/129502a52ce79743e4bb1058133e22e0/b0af8/nine_birthday.png 374w' sizes='(max-width: 374px) 100vw, 374px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>나인 생일</figcaption>\n  </figure></p>\n<p>분명 서비스에서는 00시 00분으로 잘 나오는데 왜 DB에만 9시간이 더해져서 저장되는 걸까?</p>\n<h2>원인 찾기</h2>\n<h3>가정 1. MySQL Server timezone이 UTC여서일 것이다. ❌</h3>\n<p>KST에서 UTC로 바뀌면서 시간이 변한 거라면 시간이 +9가 아니라 -9가 되었어야 했다. 그리고 Time Zone을 변경해도 계속해서 +9가 되어 시간이 저장되는 것은 변함이 없었다.</p>\n<ul>\n<li>\n<p>Ubuntu의 Server Time Zone 변경하는 방법</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Using timedatectl command (추천)</span>\n<span class=\"token operator\">></span> <span class=\"token function\">sudo</span> timedatectl set-timezone <span class=\"token string\">\"Asia/Seoul\"</span>\n<span class=\"token operator\">></span> timedatectl  <span class=\"token comment\"># 확인</span>\n\t\t\t\t\t\t\t Local time: Tue <span class=\"token number\">2022</span>-10-04 <span class=\"token number\">21</span>:31:53 KST\n           Universal time: Tue <span class=\"token number\">2022</span>-10-04 <span class=\"token number\">12</span>:31:53 UTC\n                 RTC time: Tue <span class=\"token number\">2022</span>-10-04 <span class=\"token number\">12</span>:31:54\n                Time zone: UTC <span class=\"token punctuation\">(</span>KST, +0900<span class=\"token punctuation\">)</span>\nSystem clock synchronized: <span class=\"token function\">yes</span>\n              NTP service: active\n          RTC <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">local</span> TZ: no\n\n<span class=\"token comment\"># Using /etc/localtime Symlink</span>\n<span class=\"token operator\">></span> <span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /usr/share/zoneinfo/Asia/Seoul /etc/localtime <span class=\"token comment\"># 변경</span>\n<span class=\"token operator\">></span> <span class=\"token function\">date</span> <span class=\"token comment\"># 현재 시간 확인</span>\n<span class=\"token operator\">></span> <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> mysql restart <span class=\"token comment\"># mysql 재시작</span>\n\n<span class=\"token operator\">></span> <span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/localtime <span class=\"token comment\"># UTC로 되돌리기</span></code></pre></div>\n</li>\n<li>\n<p>MySQL의 Time Zone 확인하기</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">></span> SELECT @@time_zone, now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># timezone과 현재 시간 확인</span>\n+-------------+---------------------+\n<span class=\"token operator\">|</span> @@time_zone <span class=\"token operator\">|</span> now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>               <span class=\"token operator\">|</span>\n+-------------+---------------------+\n<span class=\"token operator\">|</span> SYSTEM      <span class=\"token operator\">|</span> <span class=\"token number\">2022</span>-10-04 <span class=\"token number\">12</span>:32:40 <span class=\"token operator\">|</span>\n+-------------+---------------------+\n\n<span class=\"token operator\">></span> SHOW VARIABLES WHERE Variable_name LIKE <span class=\"token string\">'%time_zone%'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># system timezone 확인</span>\n+------------------+--------+\n<span class=\"token operator\">|</span> Variable_name    <span class=\"token operator\">|</span> Value  <span class=\"token operator\">|</span>\n+------------------+--------+\n<span class=\"token operator\">|</span> system_time_zone <span class=\"token operator\">|</span> UTC    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> time_zone        <span class=\"token operator\">|</span> SYSTEM <span class=\"token operator\">|</span>\n+------------------+--------+</code></pre></div>\n</li>\n</ul>\n<blockquote>\n<p>물론 MySQL Server Time Zone 설정을 바꾸지 않아 생기는 문제도 있다. 모든 시간이 UTC 기준으로 저장되고 있기 때문이다. Time Zone 설정을 KST로 바꾸면 모든 시간이 전부 +9가 된다.</p>\n</blockquote>\n<p>하지만 DB에 시간이 +9가 되어 저장되는 문제의 원인은 아니었다.</p>\n<h3>가정 2. yml 파일 설정의 <code class=\"language-text\">serverTimezone</code> 설정 때문이다. ⭕️</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">spring<span class=\"token operator\">:</span>\n\tdatasource<span class=\"token operator\">:</span>\n    driver<span class=\"token operator\">-</span><span class=\"token keyword\">class</span><span class=\"token operator\">-</span>name<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>mysql<span class=\"token punctuation\">.</span>cj<span class=\"token punctuation\">.</span>jdbc<span class=\"token punctuation\">.</span></span>Driver</span>\n    url<span class=\"token operator\">:</span> jdbc<span class=\"token operator\">:</span>mysql<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>어쩌고저쩌고<span class=\"token operator\">/</span>dallog<span class=\"token operator\">?</span>serverTimezone<span class=\"token operator\">=</span><span class=\"token class-name\">Asia</span><span class=\"token operator\">/</span><span class=\"token class-name\">Seoul</span></code></pre></div>\n<p>설마하는 마음으로 설정을 제거해보니 시간이 정상적으로 들어가는 것을 확인할 수 있었다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/ca73c0b22d317850251c973b572b51fd/07220/testTimeZone.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 6.470588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAT0lEQVQI1x2LRwqAMADA/IoLRax7Y2vrFv//nlg85BISx28lgSUeDem8ky0X0aDxmpmwU7jVRDKtCHki1ElpHgp9/72QB5l1uX3q7SXqNR8SASECQ0SGBwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='설정 제거 전후 비교' title='설정 제거 전후 비교' src='/static/ca73c0b22d317850251c973b572b51fd/ca1dc/testTimeZone.png' srcset='/static/ca73c0b22d317850251c973b572b51fd/e7570/testTimeZone.png 170w,\n/static/ca73c0b22d317850251c973b572b51fd/f46e7/testTimeZone.png 340w,\n/static/ca73c0b22d317850251c973b572b51fd/ca1dc/testTimeZone.png 680w,\n/static/ca73c0b22d317850251c973b572b51fd/02d09/testTimeZone.png 1020w,\n/static/ca73c0b22d317850251c973b572b51fd/07220/testTimeZone.png 1156w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>설정 제거 전후 비교</figcaption>\n  </figure></p>\n<p>그렇다면 이 문제는 왜 발생하는 것일까? 아래 그림을 보자.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/737488736db92e1180bdfe615f37c2f0/e670e/fucking_serverTimeZone.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 29.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCklEQVQY022Q2U7DQAxF8/9/RWmRoKQSeSmhL1GWZpnsS7PnMtcoiAcsWSN77OtjG9C2LAvGccQ0Tdi2janf9z9jXd/3cBxH3LZtdF0neaNtW/i+L8nb7QalFJqmkca6rhFFEdI0RZIk4rT7/Y7L5QLLsmCaJs7nd4mDIIBRlqUok3AYBvEsy4SQwkVRiLPOdV3M8yw1JFrXFYuOdTEqPZwaBj9IQUrix3EsxY/HQyYqTZfqARzCmNQULPIcrudB6b7EcxHFyY9gVVVyQ1LuzmYa179aH3g5HvF0OMhaJOdACu99iyblFoQw+PHXOWC/Yalj9fUJ6+0Vz6cTwjAUQYrwBHs931wTM/8NrHDHdoxhY+sAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='내가 그린 기린 그림' title='내가 그린 기린 그림' src='/static/737488736db92e1180bdfe615f37c2f0/ca1dc/fucking_serverTimeZone.png' srcset='/static/737488736db92e1180bdfe615f37c2f0/e7570/fucking_serverTimeZone.png 170w,\n/static/737488736db92e1180bdfe615f37c2f0/f46e7/fucking_serverTimeZone.png 340w,\n/static/737488736db92e1180bdfe615f37c2f0/ca1dc/fucking_serverTimeZone.png 680w,\n/static/737488736db92e1180bdfe615f37c2f0/02d09/fucking_serverTimeZone.png 1020w,\n/static/737488736db92e1180bdfe615f37c2f0/9d567/fucking_serverTimeZone.png 1360w,\n/static/737488736db92e1180bdfe615f37c2f0/e670e/fucking_serverTimeZone.png 1772w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>내가 그린 기린 그림</figcaption>\n  </figure></p>\n<p>JVM의 timezone은 기본값인 UTC로 설정된 상태다. 여기서 yml 설정을 통해 db의 serverTimezone을 Asia/Seoul이라고 알려줬다. 이때문에 DB에 시간이 저장되는 과정에서 자동으로 9시간을 더해준 것이다. DB에서 시간을 가져올 때는 반대로 -9시간을 적용하기 때문에 서비스 로직에는 아무 문제가 없었다.</p>\n<p>시간을 다룰 때 MySQL 서버 뿐만 아니라 JVM의 Time Zone도 고려해야 함을 잊지 말자!</p>\n<h2>해결 방법</h2>\n<p>내가 찾은 해결 방법은 두 가지다.</p>\n<h3>1. serverTimezone 설정을 제거한다.</h3>\n<p>원인을 찾았으니 원인인 serverTimezone 설정을 제거하면 문제를 해결할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">spring<span class=\"token operator\">:</span>\n\tdatasource<span class=\"token operator\">:</span>\n    driver<span class=\"token operator\">-</span><span class=\"token keyword\">class</span><span class=\"token operator\">-</span>name<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>mysql<span class=\"token punctuation\">.</span>cj<span class=\"token punctuation\">.</span>jdbc<span class=\"token punctuation\">.</span></span>Driver</span>\n    url<span class=\"token operator\">:</span> jdbc<span class=\"token operator\">:</span>mysql<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>어쩌고저쩌고<span class=\"token operator\">/</span>dallog # 설정 제거</code></pre></div>\n<h3>2. JVM의 시간 변경</h3>\n<p>설정을 제거하지 않고 문제를 해결하기 위해서는 JVM의 Time Zone과 mysql server의 Time Zone을 동일하게 맞춰주어야 한다.</p>\n<p>jar 파일 실행 시 timezone 설정을 통해 Time Zone을 Asia/Seoul로 맞춰주면 문제를 해결할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># -Duser.timezone=Asia/Seoul</span>\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token parameter variable\">-Duser.timezone</span><span class=\"token operator\">=</span>Asia/Seoul <span class=\"token parameter variable\">-Dspring.profiles.active</span><span class=\"token operator\">=</span><span class=\"token variable\">${SPRING_PROFILE}</span> /home/ubuntu/<span class=\"token variable\">$JAR_NAME</span> <span class=\"token operator\">></span> /dev/null <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">&amp;</span></code></pre></div>\n<blockquote>\n<p>달록의 경우 2번을 통해 JVM 시간과 mysql의 server 시간을 모두 Asia/Seoul로 맞춰주기로 했다.</p>\n</blockquote>\n<h4>Reference</h4>\n<p><a href=\"https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-time-instants.html\">https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-time-instants.html</a></p>\n<p><a href=\"https://tecadmin.net/linux-change-timezone/\">https://tecadmin.net/linux-change-timezone/</a></p>\n<p><a href=\"https://velog.io/@kyu/Timestamp-%EC%99%80-Datetime\">https://velog.io/@kyu/Timestamp-와-Datetime</a></p>\n<p><strong>Special Thanks To <code class=\"language-text\">애쉬</code> &#x26; <code class=\"language-text\">차리</code></strong></p>","frontmatter":{"title":"DB 시간 다루기 1 - DB에 시간이 +9 되어 저장되는 문제","date":"October 04, 2022","update":"October 04, 2022","tags":["database","time","be","파랑"],"series":"DB 시간 다루기"},"fields":{"slug":"/db-time-2-plus-nine-hours/","readingTime":{"minutes":4.545}}},"seriesList":{"edges":[{"node":{"id":"ecbb184e-af6e-56c3-bcc7-1dd21db8187d","fields":{"slug":"/db-time-1-timestamp-2038/"},"frontmatter":{"title":"DB 시간 다루기 1 - TimeStamp 2038 문제"}}},{"node":{"id":"7b08be9d-63ad-5aff-b0cb-1e873d8148ec","fields":{"slug":"/db-time-2-plus-nine-hours/"},"frontmatter":{"title":"DB 시간 다루기 1 - DB에 시간이 +9 되어 저장되는 문제"}}}]},"previous":{"fields":{"slug":"/db-time-1-timestamp-2038/"},"frontmatter":{"title":"DB 시간 다루기 1 - TimeStamp 2038 문제"}},"next":null},"pageContext":{"id":"7b08be9d-63ad-5aff-b0cb-1e873d8148ec","series":"DB 시간 다루기","previousPostId":"ecbb184e-af6e-56c3-bcc7-1dd21db8187d","nextPostId":null}},"staticQueryHashes":[]}