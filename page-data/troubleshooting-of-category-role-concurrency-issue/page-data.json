{"componentChunkName":"component---src-templates-post-jsx","path":"/troubleshooting-of-category-role-concurrency-issue/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"fe27c1ec-d040-5cf4-934a-a5eeb2131dfb","excerpt":"이 글은 우테코 달록팀 크루 후디가 작성했습니다. 오랜만의 포스팅 입니다. 이번 글에서는 달록에서 발생한 동시성 이슈를 JPA의 낙관적 락을 사용하여 해결한 경험에 대해 공유드리겠습니다. 문제 상황 달록은 카테고리 역할이라는 도메인이 존재합니다. 카테고리 역할은 현재는 크게  과  으로 나뉘어져있습니다.  은 카테고리에 대한 아무런 권한을 가지고 있지 않…","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 <a href=\"https://github.com/devHudi\">후디</a>가 작성했습니다.</p>\n</blockquote>\n<p>오랜만의 포스팅 입니다. 이번 글에서는 달록에서 발생한 동시성 이슈를 JPA의 낙관적 락을 사용하여 해결한 경험에 대해 공유드리겠습니다.</p>\n<h2>문제 상황</h2>\n<p>달록은 카테고리 역할이라는 도메인이 존재합니다. 카테고리 역할은 현재는 크게 <code class=\"language-text\">NONE</code> 과 <code class=\"language-text\">ADMIN</code> 으로 나뉘어져있습니다. <code class=\"language-text\">NONE</code> 은 카테고리에 대한 아무런 권한을 가지고 있지 않고, <code class=\"language-text\">ADMIN</code> 은 카테고리 이름 수정, 카테고리 제거, 일정 추가/제거/수정 등의 모든 권한을 가지고 있습니다. 또한 <code class=\"language-text\">ADMIN</code> 은 카테고리 구독자들의 카테고리 역할을 변경할 수 있습니다. 예를 들어, <code class=\"language-text\">NONE</code> 인 구독자를 <code class=\"language-text\">ADMIN</code> 으로 승격할 수 있고 반대로 <code class=\"language-text\">ADMIN</code> 인 구독자를 <code class=\"language-text\">NONE</code> 으로 권한을 박탈할수도 있습니다.</p>\n<p>그런데 달록은 이 구독자 카테고리 역할 변경 기능에서 동시성 이슈가 발생하였습니다. User1과 User2가 둘다 <code class=\"language-text\">ADMIN</code> 이라고 가정해봅시다. 이때, User1과 User2가 동시에 서로의 카테고리 역할을 <code class=\"language-text\">NONE</code> 으로 변경하면, 서로의 역할이 동시에 <code class=\"language-text\">NONE</code> 으로 변경됩니다.</p>\n<p>검증을 먼저 진행하고, 이후에 행위를 수행하는 경쟁 조건의 대표적인 형태인 <strong>Check-Then-Act 패턴</strong>인데요. 앞서 설명한 상황은 자기 자신의 <code class=\"language-text\">CategoryRole</code> 을 확인(Check) 하고, 상대방의 <code class=\"language-text\">CategoryRole</code>을 수정(Act) 하는 상황입니다. Check와 Act 사이에 다른 트랜잭션이 자신의 <code class=\"language-text\">CategoryRole</code>을 <code class=\"language-text\">NONE</code>으로 수정해버렸으니, 즉 Act 시점에는 이미 Check 시 검증한 사실이 유효하지 않기 때문에 발생하는 동시성 이슈이죠.</p>\n<p>달록에서의 카테고리는 최소 1명 이상의 <code class=\"language-text\">ADMIN</code> 이 존재해야하는 도메인 제약 조건이 존재합니다. <code class=\"language-text\">ADMIN</code> 이 1명도 없다면, 그 카테고리를 아무도 관리할 수 없기 때문이죠. 하지만, 위와 같은 동시성 이슈가 발생하면 앞서 이야기한 도메인 제약 조건이 깨지고, 일관성이 무너질 수 있습니다. 이를 재현해봅시다.</p>\n<h2>문제 재현</h2>\n<blockquote>\n<p>아래 코드는 문제 재현을 위해 인수 테스트 클래스에 작성한 테스트 코드입니다. 단순히 반환값을 보기 위해 작성한 코드이므로 별도의 assertion은 없습니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">concurrency_test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given절 생략</span>\n\n    <span class=\"token comment\">// when</span>\n    <span class=\"token class-name\">Thread</span> thread1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> 회원의_카테고리_역할을_변경한다<span class=\"token punctuation\">(</span>관리자<span class=\"token number\">2_</span>토큰<span class=\"token punctuation\">,</span> 카테고리<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> 관리자<span class=\"token number\">1_</span>id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryRoleUpdateRequest</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span> thread2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> 회원의_카테고리_역할을_변경한다<span class=\"token punctuation\">(</span>관리자<span class=\"token number\">1_</span>토큰<span class=\"token punctuation\">,</span> 카테고리<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> 관리자<span class=\"token number\">2_</span>id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryRoleUpdateRequest</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NONE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    thread1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    thread2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// then</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>자신이_ADMIN인_카테고리_목록을_조회한다<span class=\"token punctuation\">(</span>관리자<span class=\"token number\">1_</span>토큰<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>자신이_ADMIN인_카테고리_목록을_조회한다<span class=\"token punctuation\">(</span>관리자<span class=\"token number\">2_</span>토큰<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Given절에서는 관리자1과 관리자2 이라는 두 회원에게 <code class=\"language-text\">공통 일정</code> 이라는 카테고리에 <code class=\"language-text\">ADMIN</code> 역할을 부여하였습니다. 이 코드는 생략합니다.</p>\n<p>When절을 살펴보면 <code class=\"language-text\">회원의_카테고리_역할을_변경한다()</code> 메소드를 통해 관리자1과 관리자2은 서로의 카테고리 역할을 <code class=\"language-text\">NONE</code> 으로 변경합니다. 동시성을 위해 쓰레드를 생성하여 진행했습니다. 실제 웹 서버는 멀티 쓰레드로 동작하기 때문이죠. 모든 API의 실행이 끝날때까지 1초가량 기다린 후 Then절을 실행합니다.</p>\n<p>Then절을 살펴보면 <code class=\"language-text\">자신이_ADMIN인_카테고리_목록을_조회한다()</code> 메소드를 통해 관리자1과 관리자2의 역할이 <code class=\"language-text\">ADMIN</code> 인 카테고리 목록을 조회합니다. 우리가 원래 기대하는 결과는 관리자1 또는 관리자2 어느 한쪽은 <code class=\"language-text\">공통 일정</code> 카테고리에 대해 <code class=\"language-text\">ADMIN</code> 역할을 가지고 있어야 합니다. 하지만 동시성 이슈의 발생으로 아래와 같은 예상치 못한 결과가 나왔습니다.</p>\n<h3>관리자1 결과</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"categories\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"내 일정\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"categoryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PERSONAL\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"creator\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"devhudi@gmail.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"후디\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"profileImageUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/hudi.png\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"socialType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GOOGLE\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"createdAt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-11-06T00:06:44.98412\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>관리자2 결과</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"categories\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"내 일정\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"categoryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PERSONAL\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"creator\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dev.hyeonic@gmail.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"매트\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"profileImageUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/mat.png\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"socialType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GOOGLE\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"createdAt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-11-06T00:06:45.582431\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>관리자1, 관리자2 둘 모두 <code class=\"language-text\">공통 일정</code> 에 대한 <code class=\"language-text\">ADMIN</code> 카테고리 역할을 잃었습니다. <code class=\"language-text\">공통 일정</code> 카테고리는 더이상 관리자가 존재하지 않는 일관성이 깨진 카테고리가 되어버렸습니다. 이 문제를 어떻게 해결할 수 있을까요?</p>\n<h2>트랜잭션 격리 수준으로 해결이 되지 않는 이유</h2>\n<p>동시성 이슈와 트랜잭션 격리 수준에 대한 이해도가 낮을 때에는 격리 수준을 설정하는 것으로는 왜 이 문제가 해결되지 않는지 알지 못했습니다. 최근 낙관락/비관락에 대해 공부하면서 원인을 알게 되었어요.</p>\n<p>달록은 <code class=\"language-text\">CategoryRole</code> 엔티티를 통해 카테고리 역할을 관리합니다. 그리고 이 엔티티는 <code class=\"language-text\">category_roles</code> 라는 테이블과 매핑되어 있습니다. 이 테이블엔 더 많은 컬럼이 있지만, 대표적으로 <code class=\"language-text\">id</code> , <code class=\"language-text\">member_id</code> , <code class=\"language-text\">category_role</code> 3개의 컬럼이 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/680c5a7385b2c5ba12667a684f842f79/65922/image.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 51.764705882352935%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHstIC4/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAEQISIx/9oACAEBAAEFArNC45//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAbEAACAwADAAAAAAAAAAAAAAAAAREhMRBBcf/aAAgBAQABPyF6tqxOUO14L2Mi3j//2gAMAwEAAgADAAAAEKPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAICAgMAAAAAAAAAAAAAAQARITEQwUFxgf/aAAgBAQABPxDXLFRp7ZlTDSw4a5+nc0e41OfPH//Z'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image' title='image' src='/static/680c5a7385b2c5ba12667a684f842f79/a22ce/image.jpg' srcset='/static/680c5a7385b2c5ba12667a684f842f79/0b705/image.jpg 170w,\n/static/680c5a7385b2c5ba12667a684f842f79/31389/image.jpg 340w,\n/static/680c5a7385b2c5ba12667a684f842f79/a22ce/image.jpg 680w,\n/static/680c5a7385b2c5ba12667a684f842f79/29373/image.jpg 1020w,\n/static/680c5a7385b2c5ba12667a684f842f79/65922/image.jpg 1357w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>위와 같이 동시에 2명의 회원이 서로의 카테고리 역할을 수정할때, 이 두 트랜잭션은 서로 다른 행을 수정합니다. 애초에 양 트랜잭션이 서로 간섭하지 않는 상황이므로 트랜잭션 격리 수준으로 이 문제는 해결할 수 없죠. 다른 방법이 필요합니다.</p>\n<h2>JPA의 낙관적 락을 사용한 동시성 이슈 해결</h2>\n<p>낙관적 락은 애플리케이션 레벨에서 동시성 이슈를 해결할 수 있는 방법입니다. JPA는 낙관적 락과 비관적 락 둘다 지원합니다. 낙관적 락은 대부분의 트랜잭션이 충돌이 나지 않는 낙관적인 상황을 가정하는 방법입니다. 반대로 비관적 락은 대부분의 트랜잭션이 충돌이 발생할 것이라고 비관적으로 가정하고 우선적으로 락을 걸고 보는 방법입니다. 낙관적 락과 비관적 락에 대한 깊은 내용은 조금 더 공부한 다음 별개 포스팅으로 작성해보겠습니다.</p>\n<p>서로 동시에 <code class=\"language-text\">ADMIN</code> 권한을 내려버리는 일은 사실 자주 발생하지 않는 상황이죠. 따라서 이 경우에는 낙관적 락을 사용하는 것이 바람직합니다. 무턱대고 비관적 락을 걸어버리면, 동시성이 떨어져 성능적으로 손해를 볼 수 있기 때문입니다. 그렇다면, 달록은 낙관적 락을 어떻게 사용하여 이 문제를 해결하였을까요?</p>\n<h3>엔티티에 버전 추가</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"category_roles\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CategoryRole</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseEntity</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token annotation punctuation\">@Version</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> version<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ...</span></code></pre></div>\n<p>JPA는 낙관적 락을 버전 관리를 통해 지원합니다. 이 버전은 엔티티의 값을 변경하면 증가하게 됩니다. 트랜잭션을 커밋하는 시점에 조회한 엔티티의 버전과 실제 데이터베이스의 엔티티 버전을 비교하여 충돌 여부를 감지합니다.</p>\n<h3>레포지토리에 락 옵션 지정</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">CategoryRoleRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CategoryRole</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OPTIMISTIC</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT cr \"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"FROM CategoryRole cr \"</span>\n            <span class=\"token operator\">+</span> <span class=\"token string\">\"WHERE cr.member.id = :memberId AND cr.category.id = :categoryId\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CategoryRole</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByMemberIdAndCategoryId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> categoryId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ...</span></code></pre></div>\n<p>달록은 Spring Data JPA를 사용합니다. 따라서 위와 같이 Repository 메소드 위에 <code class=\"language-text\">@Lock</code> 어노테이션을 추가하여 락 옵션을 지정합니다.</p>\n<p><code class=\"language-text\">NONE</code> 옵션은 조회한 엔티티를 수정할 때 다른 트랜잭션에 의해 이 엔티티가 변경되지 않음을 보장합니다. 즉, 엔티티를 수정해야 버전을 체크하죠. 반면, 위 코드에서 사용한 <code class=\"language-text\">OPTIMISTIC</code> 옵션은 조회한 엔티티가 트랜잭션 동안 다른 트랜잭션에 의해 변경되지 않음을 보장합니다. 즉, 엔티티를 수정하지 않더라도 버전을 체크해요.</p>\n<p>카테고리 역할 수정 트랜잭션은 자기 자신의 <code class=\"language-text\">CategoryRole</code> 을 조회하여 역할이 <code class=\"language-text\">ADMIN</code> 임을 확인한 이후(권한 확인), 다른 사람의 <code class=\"language-text\">CategoryRole</code> 을 수정합니다. 즉, 조회만 해오는 자기 자신의 <code class=\"language-text\">CategoryRole</code> 이 트랜잭션 내내 변화하지 않음을 보장해야 합니다. 따라서 <code class=\"language-text\">OPTIMISTIC</code> 락 옵션을 사용합니다.</p>\n<h3>서비스 예외처리</h3>\n<p>낙관적 락에서 문제가 생겼을 경우 JPA는 <code class=\"language-text\">ObjectOptimisticLockingFailureException</code> 라는 예외를 던집니다. 서비스 계층에서 조금 더 추상화된 예외로 번역해서 던지도록 코드를 수정합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateRole</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> loginMemberId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> categoryId<span class=\"token punctuation\">,</span>\n                       <span class=\"token keyword\">final</span> <span class=\"token class-name\">CategoryRoleUpdateRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">CategoryRoleType</span> roleType <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getCategoryRoleType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">validateAuthority</span><span class=\"token punctuation\">(</span>loginMemberId<span class=\"token punctuation\">,</span> categoryId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">validateSoleAdmin</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> categoryId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        categoryRoleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">validateManagingCategoryLimit</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> roleType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">CategoryRole</span> categoryRole <span class=\"token operator\">=</span> categoryRoleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getByMemberIdAndCategoryId</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> categoryId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">validateCategoryType</span><span class=\"token punctuation\">(</span>categoryRole<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        categoryRole<span class=\"token punctuation\">.</span><span class=\"token function\">changeRole</span><span class=\"token punctuation\">(</span>roleType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectOptimisticLockingFailureException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryRoleConcurrencyException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">CategoryRoleConcurrencyException</code> 라는 커스텀 예외를 생성하여, 동시성 이슈가 발생했을 때 이 예외를 던지도록 작성하였습니다.</p>\n<h2>문제 해결</h2>\n<p>다시 한번 위의 테스트 코드를 실행해봅시다. 아래와 같이 관리자1 또는 관리자2 둘 중 한명은 <code class=\"language-text\">공통 일정</code> 카테고리가 관리중인 카테고리 목록에서 제거되지 않음을 확인할 수 있습니다.</p>\n<h3>관리자1 결과</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"categories\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"내 일정\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"categoryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PERSONAL\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"creator\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"devhudi@gmail.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"후디\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"profileImageUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/hudi.png\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"socialType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GOOGLE\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"createdAt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-11-06T00:58:39.262795\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"공통 일정\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"categoryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NORMAL\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"creator\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"devhudi@gmail.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"후디\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"profileImageUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/hudi.png\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"socialType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GOOGLE\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"createdAt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-11-06T00:58:39.483338\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>관리자2 결과</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"categories\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"내 일정\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"categoryType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PERSONAL\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"creator\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dev.hyeonic@gmail.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"매트\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"profileImageUrl\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/mat.png\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"socialType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GOOGLE\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"createdAt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-11-06T00:58:39.908153\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 결과는 두 트랜잭션 중 어떤 트랜잭션이 먼저 커밋되느냐에 따라 달라지겠지만, 동시성 이슈가 해결되고 도메인의 일관성이 보호되는 모습을 확인할 수 있었습니다 🙂</p>\n<h2>남는 의문점</h2>\n<p>이 문제를 해결하면서 계속 든 의문점은 <em>'왜 트랜잭션 격리 수준을 SERIALIZABLE로 해서는 이 문제를 해결할 수 없을까?'</em> 입니다. 제가 알기로는 SERIALIZABLE은 읽기 작업에 대해서도 공유 락을 획득하여, 읽어온 데이터에 대한 변경을 막는 것으로 알고 있었거든요.</p>\n<blockquote>\n<p><em>하지만 트랜잭션이 격리 수준이 SERIALIZABLE로 설정되면 읽기 작업도 공유 잠금(읽기 잠금)을 획득해야만 하며, 동시에 다른 트랜잭션은 그러한 레코드를 변경하지 못하게 된다. 즉, 한 트랜잭션에서 읽고 쓰는 레코드를 다른 트랜잭션에서는 절대 접근할 수 없는 것이다.</em> ― Real MySQL 8.0</p>\n</blockquote>\n<p>위에서 본 것 처럼 카테고리 역할 변경 로직은 <strong>(1) 자신의 CategoryRole을 가져와 권한 확인 (2) 상대방의 CategoryRole 변경</strong> 이 두 단계로 진행됩니다. 격리레벨이 SERIALIZABLE 이라면 자신의 CategoryRole을 조회하므로 이 행에 대하여 공유락이 걸려야하고, 따라서 다른 트랜잭션에서는 이 행을 수정할 수 없어야합니다.</p>\n<p>하지만 테스트 결과 트랜잭션 격리 수준을 SERIALIZABLE로 변경하기만 하는걸로는 동시성 이슈가 해결되지 않았습니다. 낙관락 혹은 비관락을 통해서만 이 문제가 해결되었는데요, 솔직히 아직 정확한 원인은 모르겠습니다. 이에 대해서는 조금 더 깊은 공부가 필요할 것 같습니다.</p>\n<h2>참고</h2>\n<ul>\n<li>자바 ORM 표준 JPA 프로그래밍, 김영한</li>\n</ul>","frontmatter":{"title":"JPA의 낙관적 락을 사용한 동시성 이슈 해결","date":"November 06, 2022","update":null,"tags":["동시성","JPA","트러블슈팅"],"series":null},"fields":{"slug":"/troubleshooting-of-category-role-concurrency-issue/","readingTime":{"minutes":15.9}}},"seriesList":{"edges":[{"node":{"id":"a621dc7b-8590-5ec6-9b52-3d9e5182486d","fields":{"slug":"/appearance-background-of-jpa/"},"frontmatter":{"title":"JPA 등장배경"}}},{"node":{"id":"9d2a87b6-2b9c-5b87-b790-3426d17c2d8e","fields":{"slug":"/intellij-final-keyword/"},"frontmatter":{"title":"IntelliJ에서 메소드 추출한 메소드의 파라미터에 final 키워드 자동 추가하기"}}},{"node":{"id":"251e9767-1c92-5cf5-9cef-2c4a42c10df2","fields":{"slug":"/git-branch-strategy/"},"frontmatter":{"title":"달록팀의 git 브랜치 전략을 소개합니다."}}},{"node":{"id":"5090cce3-0c1f-5376-badc-1d25e44c1bd9","fields":{"slug":"/infinite-scroll/"},"frontmatter":{"title":"React에서 무한 스크롤 구현하기"}}},{"node":{"id":"bcb53ba5-0286-5d10-96c2-fdcb88e2cc60","fields":{"slug":"/package-structure/"},"frontmatter":{"title":"달록에 적절한 패키지 구조 고민하기"}}},{"node":{"id":"a7fc89de-f37c-596e-a81d-3d4fe5a795b8","fields":{"slug":"/data-jpa-slice-page/"},"frontmatter":{"title":"Spring Data JPA의 Slice & Page"}}},{"node":{"id":"e1ba92ee-0cf0-50c8-80bd-5da5075df8d1","fields":{"slug":"/data-jpa-auditing/"},"frontmatter":{"title":"Spring Data JPA의 Auditing"}}},{"node":{"id":"3e036508-c916-504e-9e8d-89f69332471e","fields":{"slug":"/separated-interface/"},"frontmatter":{"title":"외부와 의존성 분리하기"}}},{"node":{"id":"cade544a-16ef-58a3-b97c-824986a8395f","fields":{"slug":"/apply-rest-docs/"},"frontmatter":{"title":"MockMvc를 사용한 Spring RestDocs"}}},{"node":{"id":"87649d54-d59e-58a6-afd5-8491eb4113a8","fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}}},{"node":{"id":"eb380f6d-5a00-5a9e-a916-003fb292cc8a","fields":{"slug":"/test-fixture-constant/"},"frontmatter":{"title":"테스트에서 Entity 객체를 상수로 두면 안 되는 이유"}}},{"node":{"id":"9734e30a-b430-5922-919d-f53808a56eb9","fields":{"slug":"/what_is_nginx/"},"frontmatter":{"title":"NGINX 란?"}}},{"node":{"id":"9ebc6e21-2a76-5d42-be33-c2dae8c849b2","fields":{"slug":"/ssl_protocol/"},"frontmatter":{"title":"SSL을 통한 HTTPS통신 과정"}}},{"node":{"id":"fa5ad595-1f81-5a20-a884-2da69adee3c5","fields":{"slug":"/integration-test-slice-test/"},"frontmatter":{"title":"통합 테스트와 슬라이스 테스트"}}},{"node":{"id":"d8c66823-bb05-5e83-a6a1-2fd9af450b6f","fields":{"slug":"/query-invalidation/"},"frontmatter":{"title":"React-Query에서의 데이터 최신화 (Query Invalidation)"}}},{"node":{"id":"f5187517-342f-52a1-9092-d12c1a80d132","fields":{"slug":"/seperate-components/"},"frontmatter":{"title":"컴포넌트 분리 기준"}}},{"node":{"id":"d6249c8b-bea6-5c91-8477-d3dd15ad9b39","fields":{"slug":"/test-isolation/"},"frontmatter":{"title":"테스트 격리"}}},{"node":{"id":"98e390ef-fb19-5d01-a3ef-d14bc0e65176","fields":{"slug":"/dallog-jacoco/"},"frontmatter":{"title":"달록의 Jacoco 적용기 (feat. Gradle)"}}},{"node":{"id":"ab7073d6-575f-55b8-8b1d-fec1ea27916f","fields":{"slug":"/cannot-scroll-to-top-of-flex-element/"},"frontmatter":{"title":"스크롤을 했더니 윗부분이 안 보여요!"}}},{"node":{"id":"33d19946-de0c-5b41-bfa0-d7c3fd80f10b","fields":{"slug":"/google-refresh-token/"},"frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다."}}},{"node":{"id":"8168857d-a82c-5608-bd40-cea4b917d17d","fields":{"slug":"/submodule/"},"frontmatter":{"title":"달록 서브모듈 도입기"}}},{"node":{"id":"836fc724-7e2f-5c7a-a42b-c0cc9163167a","fields":{"slug":"/dallog-flyway/"},"frontmatter":{"title":"달록의 데이터베이스 마이그레이션을 위한 Flyway 적용기"}}},{"node":{"id":"7a3bde6d-746b-56fd-8d91-0d8059ebf1f8","fields":{"slug":"/json-property-json-naming/"},"frontmatter":{"title":"@JsonProperty, @JsonNaming"}}},{"node":{"id":"50673f5c-f835-5982-b70c-b77e5a352a2c","fields":{"slug":"/servlet-life-cycle/"},"frontmatter":{"title":"서블릿 생명주기와 직접만든 톰캣을 통한 의문점"}}},{"node":{"id":"61e7f4d1-7b3a-5968-bfe8-c3f6efb88748","fields":{"slug":"/preparing-for-performance-test/"},"frontmatter":{"title":"톰캣 튜닝을 위한 달록의 서버 성능 테스트 준비 과정"}}},{"node":{"id":"9272061d-68c6-5f82-a961-0e2efe0fd6be","fields":{"slug":"/cyclic-dependency/"},"frontmatter":{"title":"cyclic dependency"}}},{"node":{"id":"6e779308-f266-58af-bfcc-e9fee6d39a98","fields":{"slug":"/multi-datasource-issue-with-osiv/"},"frontmatter":{"title":"대체 왜 DataSource 라우팅이 안되는거야!? (feat. OSIV)"}}},{"node":{"id":"c7bea043-345c-5f78-ae53-796a83812961","fields":{"slug":"/react-query-useMutation-trouble-shooting/"},"frontmatter":{"title":"react-query useMutation onSuccess 안 되는줄 알았던 트러블 슈팅"}}},{"node":{"id":"cf403487-1c48-5ca7-b5c2-ef0d8fefe3c4","fields":{"slug":"/jenkins-distributed-build-architecture/"},"frontmatter":{"title":"젠킨스 분산 빌드 아키텍처 구축"}}},{"node":{"id":"24c152c7-4e94-5b84-aaea-a5a9a8357693","fields":{"slug":"/zero-downtime-deployment/"},"frontmatter":{"title":"달록 무중단 배포 도입기"}}},{"node":{"id":"623f9105-974d-51b9-84c7-f6298a8d1c19","fields":{"slug":"/get-valid-accessToken/"},"frontmatter":{"title":"refreshToken으로 accessToken 재발급하기"}}},{"node":{"id":"d34299f0-eb49-5aef-a38f-963200d5fd6d","fields":{"slug":"/test-readability/"},"frontmatter":{"title":"어떻게 테스트 코드 가독성을 개선할 수 있을까??"}}},{"node":{"id":"fe27c1ec-d040-5cf4-934a-a5eeb2131dfb","fields":{"slug":"/troubleshooting-of-category-role-concurrency-issue/"},"frontmatter":{"title":"JPA의 낙관적 락을 사용한 동시성 이슈 해결"}}}]},"previous":{"fields":{"slug":"/test-readability/"},"frontmatter":{"title":"어떻게 테스트 코드 가독성을 개선할 수 있을까??"}},"next":null},"pageContext":{"id":"fe27c1ec-d040-5cf4-934a-a5eeb2131dfb","series":null,"previousPostId":"d34299f0-eb49-5aef-a38f-963200d5fd6d","nextPostId":null}},"staticQueryHashes":[]}