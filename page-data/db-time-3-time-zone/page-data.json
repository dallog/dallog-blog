{"componentChunkName":"component---src-templates-post-jsx","path":"/db-time-3-time-zone/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"baa7d054-550b-572e-a8c8-337f87b42bf6","excerpt":"이 글은 우테코 달록팀 크루 파랑이 작성했습니다. 시간과 날짜를 다루는 달록을 개발하다보니 타임존을 설정할 수 있는 곳과 그 방법이 아주 다양하다는 걸 알게 되었다. 설정 방법과 그 결과를 공유해보려 한다. TimeZone 설정할 수 있는 곳 1. yml 파일 설정 이 설정은 실제로 DB 서버의 타임존을 변경하지는 않는다. 단순히 Spring에게 DB의 …","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 <a href=\"https://github.com/summerlunaa\">파랑</a>이 작성했습니다.</p>\n</blockquote>\n<p>시간과 날짜를 다루는 달록을 개발하다보니 타임존을 설정할 수 있는 곳과 그 방법이 아주 다양하다는 걸 알게 되었다. 설정 방법과 그 결과를 공유해보려 한다.</p>\n<h1>TimeZone 설정할 수 있는 곳</h1>\n<h2>1. yml 파일 설정</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">spring<span class=\"token operator\">:</span>\n\tdatasource<span class=\"token operator\">:</span>\n    driver<span class=\"token operator\">-</span><span class=\"token keyword\">class</span><span class=\"token operator\">-</span>name<span class=\"token operator\">:</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>mysql<span class=\"token punctuation\">.</span>cj<span class=\"token punctuation\">.</span>jdbc<span class=\"token punctuation\">.</span></span>Driver</span>\n    url<span class=\"token operator\">:</span> jdbc<span class=\"token operator\">:</span>mysql<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>어쩌고저쩌고<span class=\"token operator\">/</span>dallog<span class=\"token operator\">?</span>serverTimezone<span class=\"token operator\">=</span><span class=\"token class-name\">Asia</span><span class=\"token operator\">/</span><span class=\"token class-name\">Seoul</span></code></pre></div>\n<p>이 설정은 실제로 DB 서버의 타임존을 변경하지는 않는다. 단순히 Spring에게 DB의 서버 타임존이 이것이니, 이에 맞게 동작(time zone에 맞춰 시간을 더하거나 빼주는 행위)하라고 알려주는 것 뿐이다.</p>\n<p>다른 설정 없이 이 설정만 적용하면 모든 datetime 값이 아래처럼 +9시간 되어 저장된다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/128bda3853ee459d7789c2e91fd444be/50bf7/serverTimezone.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLElEQVQY011R7WqEMBD0/V/npIW+wPXgBKHVo5Q79PTUmPgVv+LZOt1NWyj9MbDZ7ExmNs40TZBSwvM8hGGIIAig+x7zPANmxtZrbNOIbRwAwrYYzMYgjmMcj0eENO/7PpRSMNR3siyzBQszuO5JUBQFNlXiM0vwQdhEDnN+xyoFsjzHOI52fmDebKC7Djn1nY4KrTUKEqiqCmma2uEoiiDIuaprKOpXTYNcCETXq03EAqIsoWWJRhRo6dzQjBXsftTZdpIkGIbBCjJRqgolEZWSyG43e89n5hT0gKa6LnI0bfstyM7WdcWyLBZccxR+ICY3/vMeT48P2O1cuK5rkzB4NXeaN4Q7cdiEjcz7+nX5Fxy7o1XUbyecX1+wPxxwuVzsZ/3ncPyWHLKRLzQ4woubTgx8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='serverTimezone을 설정했을 때 일어나는 현상' title='serverTimezone을 설정했을 때 일어나는 현상' src='/static/128bda3853ee459d7789c2e91fd444be/ca1dc/serverTimezone.png' srcset='/static/128bda3853ee459d7789c2e91fd444be/e7570/serverTimezone.png 170w,\n/static/128bda3853ee459d7789c2e91fd444be/f46e7/serverTimezone.png 340w,\n/static/128bda3853ee459d7789c2e91fd444be/ca1dc/serverTimezone.png 680w,\n/static/128bda3853ee459d7789c2e91fd444be/02d09/serverTimezone.png 1020w,\n/static/128bda3853ee459d7789c2e91fd444be/50bf7/serverTimezone.png 1342w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>serverTimezone을 설정했을 때 일어나는 현상</figcaption>\n  </figure></p>\n<h2>2. MySQL 서버 설정</h2>\n<p>여기서 타임존을 바꾸려면 timedatectl을 사용하는 방법과 symlink를 사용하는 방법이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># 1. Using timedatectl command (추천)</span>\n<span class=\"token operator\">></span> sudo timedatectl <span class=\"token keyword\">set</span><span class=\"token operator\">-</span>timezone <span class=\"token string\">\"Asia/Seoul\"</span>\n\n<span class=\"token comment\"># 2. Using /etc/localtime Symlink</span>\n<span class=\"token operator\">></span> sudo cp <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token keyword\">share</span><span class=\"token operator\">/</span>zoneinfo<span class=\"token operator\">/</span>Asia<span class=\"token operator\">/</span>Seoul <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>localtime\n\n<span class=\"token comment\"># timedatectl로 변경사항 확인</span>\n<span class=\"token operator\">></span> timedatectl\n\t\t\t\t\t\t\t <span class=\"token keyword\">Local</span> <span class=\"token keyword\">time</span>: Tue <span class=\"token number\">2022</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">04</span> <span class=\"token number\">21</span>:<span class=\"token number\">31</span>:<span class=\"token number\">53</span> KST\n           Universal <span class=\"token keyword\">time</span>: Tue <span class=\"token number\">2022</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">04</span> <span class=\"token number\">12</span>:<span class=\"token number\">31</span>:<span class=\"token number\">53</span> UTC\n                 RTC <span class=\"token keyword\">time</span>: Tue <span class=\"token number\">2022</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">04</span> <span class=\"token number\">12</span>:<span class=\"token number\">31</span>:<span class=\"token number\">54</span>\n                <span class=\"token keyword\">Time</span> zone: UTC <span class=\"token punctuation\">(</span>KST<span class=\"token punctuation\">,</span> <span class=\"token operator\">+</span><span class=\"token number\">0900</span><span class=\"token punctuation\">)</span>\nSystem clock synchronized: yes\n              NTP service: active\n          RTC <span class=\"token operator\">in</span> <span class=\"token keyword\">local</span> TZ: <span class=\"token keyword\">no</span>\n\n<span class=\"token comment\"># date 명령어로 현재 시간 확인</span>\n<span class=\"token comment\"># 위의 값과 다를 수 있으니 둘 다 확인하는 것이 좋다</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">date</span> \n\n<span class=\"token comment\"># mysql에 time zone 적용을 위해 재시작한다</span>\n<span class=\"token operator\">></span> sudo service mysql restart \n\n<span class=\"token comment\"># UTC로 되돌리기</span>\n<span class=\"token comment\"># 주의: sudo timedatectl set-timezone \"UTC\" 명령어를 사용해도 원래대로 돌아가지 않는다. 꼭 아래의 명령어를 사용해서 파일을 삭제해주어야 한다.</span>\n<span class=\"token operator\">></span> sudo rm <span class=\"token operator\">-</span>f <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>localtime <span class=\"token comment\"># UTC로 되돌리기</span></code></pre></div>\n<p>MySQL 안에서 확인하려면 아래의 명령어를 사용하면 된다. 값이 SYSTEM인 경우 서버의 설정 값을 따라간다는 뜻이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token operator\">></span> <span class=\"token keyword\">SHOW</span> VARIABLES <span class=\"token keyword\">WHERE</span> Variable_name <span class=\"token operator\">LIKE</span> <span class=\"token string\">'%time_zone%'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------------+--------+</span>\n<span class=\"token operator\">|</span> Variable_name    <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span>  <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------------+--------+</span>\n<span class=\"token operator\">|</span> system_time_zone <span class=\"token operator\">|</span> KST    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> time_zone        <span class=\"token operator\">|</span> SYSTEM <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------------+--------+</span>\n\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> @<span class=\"token variable\">@GLOBAL.time_zone</span><span class=\"token punctuation\">,</span> @<span class=\"token variable\">@SESSION.time_zone</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+---------------------+</span>\n<span class=\"token operator\">|</span> @<span class=\"token variable\">@GLOBAL.time_zone</span> <span class=\"token operator\">|</span> @<span class=\"token variable\">@SESSION.time_zone</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+---------------------+</span>\n<span class=\"token operator\">|</span> SYSTEM             <span class=\"token operator\">|</span> SYSTEM              <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+---------------------+</span></code></pre></div>\n<p>이는 말 그대로 MySQL의 타임존을 변경하는 것이다. 다른 설정들이 모두 UTC인데 db 서버만 KST로 변경하는 것은 무의미하다. 다른 특별한 설정이 없으므로 직접 시간을 넣어주는 <code class=\"language-text\">start_date_time</code>, <code class=\"language-text\">end_date_time</code>의 경우 값이 그대로 들어간다. 하지만  <code class=\"language-text\">created_at</code> , <code class=\"language-text\">updated_at</code> 과 같이 현재 시간이 찍히는 값은 UCT 시간으로 저장된다.</p>\n<h2>3. system properties의 user.timezone 설정</h2>\n<p>이 변수를 설정하는 방법은 두 가지가 있다.</p>\n<h3>3-1. jar 파일 실행 시 설정</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># -Duser.timezone=Asia/Seoul</span>\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token parameter variable\">-Duser.timezone</span><span class=\"token operator\">=</span>Asia/Seoul <span class=\"token parameter variable\">-Dspring.profiles.active</span><span class=\"token operator\">=</span><span class=\"token variable\">${SPRING_PROFILE}</span> /home/ubuntu/<span class=\"token variable\">$JAR_NAME</span> <span class=\"token operator\">></span> /dev/null <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">&amp;</span></code></pre></div>\n<p>system properties의 user.timezone을 설정할 수 있다. 이를 설정하면 <code class=\"language-text\">created_at</code> , <code class=\"language-text\">updated_at</code> 과 같이 현재 시간이 찍히는 값도 한국 시간으로 DB에 잘 저장된다.</p>\n<h3>3-2. 애플리케이션 레벨에서 SpringBoot 설정</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TimeZoneConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">DEFAULT_TIME_ZONE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Asia/Seoul\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setDefaultTimeZone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">TimeZone</span><span class=\"token punctuation\">.</span><span class=\"token function\">setDefault</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TimeZone</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTimeZone</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DEFAULT_TIME_ZONE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">TimeZone.setDefault</code> 메서드를 사용하면 같은 설정을 애플리케이션 레벨에서 설정할 수 있다. 메서드를 자세히 보면 아래와 같은 로직이 있다. 즉, 3-1 방법과 동일하게 system properties의 user.timezone의 값을 바꿔주는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SecurityManager</span> sm <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSecurityManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tsm<span class=\"token punctuation\">.</span><span class=\"token function\">checkPermission</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PropertyPermission</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user.timezone\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"write\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>로컬에서는 이렇게 해도 서버 시간이 잘 변경되지만 이상하게 배포 서버에서는 설정이 적용되지 않고 모든 시간이 -9시간으로 저장된다. 다른 팀에서도 같은 문제를 겪었다고 한다. 분명 3번이랑 같은 변수를 설정해주는 방법인데 왜 결과가 다르게 나오는지 모르겠다.</p>\n<p>아마 아래와 같은 느낌으로 동작하는 것 같지만 원인은 모른다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/ea2fd338ead2b5e0d93ca23e637c96ea/329d6/jvm_timezone.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVQY021Qa0/CUAzd//8lEvwTJkZEYzBugDg3t5G92WXvuwfs2F7wC7HJSZs+Tk+rNW0LsdtArHUczS+I9zcI+xutlGAbhgFd1ylwzDaOI+I4xmq1gmEYypumiaZpoIVhiL6uIMsCssjRiYx8gThJ1HCWZXBdF7ZtI7nm8jzH4XBAWZYQFB8JkgT4vg+NC6dpQk1KZd+jIj+ezwiCQJHxcEELGFEUKfBMXdfoqX8inIhsINVpml4Iuelzu4XjONB1XZ1jWdaFlOp/xHxNSLn9fq96dnRm4fwgM3ewHRcJ5TRm/c8EkTDBh25guVzihfC0WGC92ahfsbpbY3Hqh7dgZQktmmSL+PUZ89kdZvN7eI8PwJHUVhU8+qt6wXWGY8/z8AvkJsEn0UdMEwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='애플리케이션 레벨에서 타임존을 설정했을 때 일어나는 현상' title='애플리케이션 레벨에서 타임존을 설정했을 때 일어나는 현상' src='/static/ea2fd338ead2b5e0d93ca23e637c96ea/ca1dc/jvm_timezone.png' srcset='/static/ea2fd338ead2b5e0d93ca23e637c96ea/e7570/jvm_timezone.png 170w,\n/static/ea2fd338ead2b5e0d93ca23e637c96ea/f46e7/jvm_timezone.png 340w,\n/static/ea2fd338ead2b5e0d93ca23e637c96ea/ca1dc/jvm_timezone.png 680w,\n/static/ea2fd338ead2b5e0d93ca23e637c96ea/02d09/jvm_timezone.png 1020w,\n/static/ea2fd338ead2b5e0d93ca23e637c96ea/329d6/jvm_timezone.png 1326w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>애플리케이션 레벨에서 타임존을 설정했을 때 일어나는 현상</figcaption>\n  </figure></p>\n<p>이 경우 MySQL의 타임존을 Asia/Seoul로 JVM 시간과 같게 맞춰주면 원하는 대로 동작한다.</p>\n<h2>정리</h2>\n<p>원하는 결과: DB에 일정의 일시와 데이터의 생성, 수정 일시가 한국 시간으로 들어갔으면 좋겠다.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>JVM 타임존</th>\n<th>DB 타임존</th>\n<th>결과</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1. yml 설정</td>\n<td>UTC</td>\n<td>UTC</td>\n<td>모두 +9로 저장</td>\n</tr>\n<tr>\n<td>2. MySQL 서버 설정</td>\n<td>UTC</td>\n<td>Asia/Seoul</td>\n<td>일정의 일시는 원하는 대로 저장, 데이터의 생성, 수정 일시가 -9로 저장</td>\n</tr>\n<tr>\n<td>3-1. jar 파일 실행 시 설정</td>\n<td>Asia/Seoul</td>\n<td>UTC</td>\n<td>모두 원하는 대로 저장</td>\n</tr>\n<tr>\n<td>3-2. 애플리케이션 레벨에서 SpringBoot 설정</td>\n<td>Asia/Seoul</td>\n<td>UTC</td>\n<td>모두 -9로 저장</td>\n</tr>\n</tbody>\n</table>\n<p>결론: 지금으로썬 3-1 방법이 가장 간단한 방법이다.</p>\n<p><strong>Special Thanks To <code class=\"language-text\">제이슨</code></strong></p>","frontmatter":{"title":"달력 서비스의 DB 시간 다루기 3 - Time Zone, 어디서 어떻게 설정해야 할까?","date":"October 18, 2022","update":"October 18, 2022","tags":["database","timezone","be","파랑"],"series":"달력 서비스의 DB 시간 다루기"},"fields":{"slug":"/db-time-3-time-zone/","readingTime":{"minutes":6.165}}},"seriesList":{"edges":[{"node":{"id":"ecbb184e-af6e-56c3-bcc7-1dd21db8187d","fields":{"slug":"/db-time-1-timestamp-2038/"},"frontmatter":{"title":"달력 서비스의 DB 시간 다루기 1 - TimeStamp 2038 문제"}}},{"node":{"id":"7b08be9d-63ad-5aff-b0cb-1e873d8148ec","fields":{"slug":"/db-time-2-plus-nine-hours/"},"frontmatter":{"title":"달력 서비스의 DB 시간 다루기 2 - DB에 시간이 +9 되어 저장되는 문제"}}},{"node":{"id":"baa7d054-550b-572e-a8c8-337f87b42bf6","fields":{"slug":"/db-time-3-time-zone/"},"frontmatter":{"title":"달력 서비스의 DB 시간 다루기 3 - Time Zone, 어디서 어떻게 설정해야 할까?"}}}]},"previous":{"fields":{"slug":"/react-query-useMutation-trouble-shooting/"},"frontmatter":{"title":"react-query useMutation onSuccess 안 되는줄 알았던 트러블 슈팅"}},"next":null},"pageContext":{"id":"baa7d054-550b-572e-a8c8-337f87b42bf6","series":"달력 서비스의 DB 시간 다루기","previousPostId":"c7bea043-345c-5f78-ae53-796a83812961","nextPostId":null}},"staticQueryHashes":[]}