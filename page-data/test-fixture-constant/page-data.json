{"componentChunkName":"component---src-templates-post-jsx","path":"/test-fixture-constant/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"eb380f6d-5a00-5a9e-a916-003fb292cc8a","excerpt":"이 글은 우테코 달록팀 크루 파랑이 작성했습니다. 문제 에서 카테고리 수정 기능에 대한 테스트가 터졌다.  시 다른 회원의 id를 넣으면 이 발생해야 하는데 아무런 예외도 발생하지 않았다. 더 이상한 점은 단독으로 돌렸을 때는 잘 돌아가지만 전체 테스트를 돌리면 터진다는 것이다. 테스트 격리에 문제가 있어 보였다. 디버깅을 해보았다.  MEMBER까지 저…","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 <a href=\"https://github.com/summerlunaa\">파랑</a>이 작성했습니다.</p>\n</blockquote>\n<h2>문제</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// MemberFixtures</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Member</span> <span class=\"token constant\">MEMBER</span> \n\t\t<span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"example@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/image.png\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Member</span> <span class=\"token constant\">CREATOR</span> \n\t\t<span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"creator@email.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/image.png\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"creator\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// CategoryServiceTest</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"자신이 만들지 않은 카테고리를 수정할 경우 예외를 던진다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> 자신이_만들지_않은_카테고리를_수정할_경우_예외를_던진다<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Member</span> creator <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">CategoryResponse</span> savedCategory <span class=\"token operator\">=</span> categoryService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>creator<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryCreateRequest</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CATEGORY_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">CategoryUpdateRequest</span> categoryUpdateRequest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryUpdateRequest</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MODIFIED_CATEGORY_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when &amp; then</span>\n    <span class=\"token function\">assertThatThrownBy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> categoryService<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> savedCategory<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> categoryUpdateRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isInstanceOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NoPermissionException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">CategoryServiceTest</code>에서 카테고리 수정 기능에 대한 테스트가 터졌다. <code class=\"language-text\">update</code> 시 다른 회원의 id를 넣으면 <code class=\"language-text\">NoPermissionException</code>이 발생해야 하는데 아무런 예외도 발생하지 않았다. 더 이상한 점은 단독으로 돌렸을 때는 잘 돌아가지만 전체 테스트를 돌리면 터진다는 것이다. 테스트 격리에 문제가 있어 보였다. 디버깅을 해보았다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/dcb6e569607bb8e161a8d5b0fc9a001f/08990/debug1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.76470588235294%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQY04WR2WrDMBBF81nZZG3WbsuyjZsUp+v//8PtWIW0lEIeDkJoOPcy2p2FwpwEbp1HchHGR9iQ4EKH1gUIbXBqJCFw4o/Z7ZlCJuF7UehdB+0ddHQwFCC9AWslmFY0LP/wQPhZWqwh4ylEXBI1dQY8aMikwb3GkYYPjFeOta38l5+Gg8YaMz66jNEncGugk4EkcSM1GCFbW2G0pgNr7gEb+/P3/S58GxRuJHxJPe0xwFBTF9MvOqRcMC0XBApV1tcdK+vqaeldUFgV9lHglRpuwpUeDA20JN1E2ydtcl+DIoZpRl9GYkKZl3rmccZyfa6BX2nO2UiOOLyaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='member 객체' title='member 객체' src='/static/dcb6e569607bb8e161a8d5b0fc9a001f/ca1dc/debug1.png' srcset='/static/dcb6e569607bb8e161a8d5b0fc9a001f/e7570/debug1.png 170w,\n/static/dcb6e569607bb8e161a8d5b0fc9a001f/f46e7/debug1.png 340w,\n/static/dcb6e569607bb8e161a8d5b0fc9a001f/ca1dc/debug1.png 680w,\n/static/dcb6e569607bb8e161a8d5b0fc9a001f/08990/debug1.png 1010w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>member 객체</figcaption>\n  </figure></p>\n<p>MEMBER까지 저장했을 때는 분명 값들이 잘 들어가있는 걸 볼 수 있다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/2fb95a1ec531ee3668aeec9ea95f76b0/1263b/debug2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 65.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7ElEQVQ4y41TWXbiMBD0rSYQsGwt1mZZXoCQkMwk9z9ETatNeGTebB/11BJSubqqqRolcYgtLj4iWwftAjoX0dHeUC07i0fREpr/QvWwJ8LU4Jw71HaAdB7Ke3QxoDUddk27EtbNlbj9B2EtMfcCx6lHH46YncEYOmhv0ESFNmoIp/jytl7xlfwrmHBhQmqxv8ANr4jxQOoUmqBRG4m9lHx5d/fwk/xXVJurwnN2yP0T5nSgtiN5SW2HAOMJNkBbj5Ay8nzgs11DH2rVDbXUfFZ9Iw+XVGMYIzbpAyJd6LHjQGzob6uNK5bTE9I0I40zxuWIPk8YpoXPXZ9QCakoZUHKJqj0DNGfOOlC5GJipY3uCIZVKFIqO8fpr7WFNJZUR7LJonoUa8pvvYGli8Y7/rGoUbQvbdx7tNkLbK/gul7xWfPYTOThe9aU8EAzaKlFSjl2aD0lbMkfo/6Y6m9TnpPARzZ48QkX8utMCpWhsfGKRkZy0luxqluV/GVsSsojKfxBCt9Cxns/oCf/ms6QSsvD3ajVw+Jr+QcJpfGwqxnlA/f1TeH3QeE1DKywmF0ecroEF9e1jM1yOiPm8bYvXnsSUc7KaLHCIVIoSTPhM13UFIa+kpbVXFMvIZVxCUNGHEYeF66JbDqceCp+AuCa1l08A/3mAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='필드가 변경된 member 객체' title='필드가 변경된 member 객체' src='/static/2fb95a1ec531ee3668aeec9ea95f76b0/ca1dc/debug2.png' srcset='/static/2fb95a1ec531ee3668aeec9ea95f76b0/e7570/debug2.png 170w,\n/static/2fb95a1ec531ee3668aeec9ea95f76b0/f46e7/debug2.png 340w,\n/static/2fb95a1ec531ee3668aeec9ea95f76b0/ca1dc/debug2.png 680w,\n/static/2fb95a1ec531ee3668aeec9ea95f76b0/1263b/debug2.png 1000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>필드가 변경된 member 객체</figcaption>\n  </figure></p>\n<p>근데 CREATOR를 저장하는 순간!? member의 값이 갑자기 CREATOR의 값으로 전부 변경되었다. 왜 이런 걸까.</p>\n<h2>원인</h2>\n<blockquote>\n<p>가변객체인 회원의 Entity를 상수로 등록하여 사용하고 있는 것이 문제였다.</p>\n</blockquote>\n<p>아래 그림을 통해 알아보자.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1e3d82342c6106de7875c7eccdba5905/1b198/img1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 52.352941176470594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABO0lEQVQoz62S24rCQBBEExNNvGFuRlFRfBBzhyRolPyDzwr+/2/UUg0ji4YFYR+GycykD9VVrQVBgMPhgPl8DsMwYJomHMeBbdvo9XoYDAbQNE3uLpcLmqb5WOfzGdfrFVmWQSNgOp0KiIWErlYrjEYjOf8Gsvh0OnUuvqVpCi0MQyETkuc5qqpCURRIkkTul8tlJ5CqOoFUt9vtMBwOpdD3fURRJHe6rv+pkFAFfgEXi4Uo2W630jZbnc1mLxuUFQpY1zVutxuezycejwfu9zvathWwABnK8XjEZrNBv9+XIMbjsXzTT+7vCpWyToUqFIL+JRSOC1umd3EcoyzLVyj8wXXd74D0a7/fYzKZSCGVcS49z/tQyDlUbb7PId9kDukXR4NAts/zer2WYHi2LEuAfGf69Ltrqcn4Ae1rE0eDI7LDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img1' title='img1' src='/static/1e3d82342c6106de7875c7eccdba5905/ca1dc/img1.png' srcset='/static/1e3d82342c6106de7875c7eccdba5905/e7570/img1.png 170w,\n/static/1e3d82342c6106de7875c7eccdba5905/f46e7/img1.png 340w,\n/static/1e3d82342c6106de7875c7eccdba5905/ca1dc/img1.png 680w,\n/static/1e3d82342c6106de7875c7eccdba5905/02d09/img1.png 1020w,\n/static/1e3d82342c6106de7875c7eccdba5905/1b198/img1.png 1120w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>테스트 실행 전 MEMBER와 CREATOR는 id를 가지지 않은 상태이다. 영속성 컨텍스트도 비어있다.</p>\n<p>전체 테스트를 실행하면 MEMBER와 CREATOR는 상수이므로 온갖 테스트에서 두 개의 상수를 가져다 쓰게 된다. 그 과정에서 MEMBER가 저장되는 상황이 발생한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/426794044d48de3123daaa8a0ab7439b/65dc2/img2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 52.352941176470594%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVQoz01SZ6siQRCcZ866hhPMERVUPF0jBsS0ngFBn4Lh//+Muq2+p9yHoqd7t2u6q0aFw2Fks1lEo1FYbTZYLF+w2p2wWq3m2QK73Q6lFLw+H/r9PqbTKV6vFy6XC263G+73O47Ho3wjlNvtRiQSAaPX64XH40EwFDbPPqkxJyFju90WLBYLrFYricvlErPZDN1uV6BisRhqtRoSiQSazaag0+mgWq2iXq8jmUrBFS3Br/2CsdngdDphPp+j1WrJf+32b4kfQr/fj0wmI9NxkmAwiEqlgnw+L7nlS8GlpaAlK9j9MXD5/sZ6vZb1hsOhiZGJAQaDf1CcjDeQxOl0ypqhUAiBQED0s5m6kjicLGM0GmIymcgk7OnoXei9IXSeTfACpWka0uk04vH4xwDqxfP/pnjcTuz3ezHjcDjg8XiIIc/nE9frVUBNFZupI6PL5RIUi0VxnWRvU2iSYRhCRg1pBC84n8/Ybrcy+Xg8hqLDpVIJnJREFLtcLkuNMnD999R0drfbmauPoOs6Nj8m0WnmoiEJ6TLfI98eTWo0GkiZ7nJlh8PxM6EXvV7v00i8tWSd+gkhTSAZG7gic65LYuY0ioQkLhQK4j6Ry+Ukvmvv/C8XKR0sehv9NwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img2' title='img2' src='/static/426794044d48de3123daaa8a0ab7439b/ca1dc/img2.png' srcset='/static/426794044d48de3123daaa8a0ab7439b/e7570/img2.png 170w,\n/static/426794044d48de3123daaa8a0ab7439b/f46e7/img2.png 340w,\n/static/426794044d48de3123daaa8a0ab7439b/ca1dc/img2.png 680w,\n/static/426794044d48de3123daaa8a0ab7439b/65dc2/img2.png 954w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>그럼 상수 MEMBER의 id 값이 1로 바뀌게 된다. 이후 다른 테스트에서는 CREATOR가 저장된다. 이 때 각각의 테스트는 격리되어 있으므로 영속성 컨텍스트는 빈 상태이다. 따라서 CREATOR의 id도 1로 저장된다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fe0781b8ad1359d3e25de8952645dc16/ef0cc/img3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 52.94117647058824%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+klEQVQoz2WSV4siURCFO5kdA6YG44pZW0xrQhzBwDyIOmNCQf//vzjbp3oVln049L0X+qtTdUrpdDpoNpswDAOqqv4nRVFEmUwG5XIZhUIB+Xxevi8Vi0VUKhXEYjEo2WwWyWTyDdQNNzTdgKap8qbrugDb7TYmkwnO5zMejwdOpxOezyculwuWyyWm06kUUhKJBAKBgCO/H5FoDB+hEPz2mXK5XAKs1+vo9XqYz+dYr9dYrVaiF2w0GoHmFNpNpVKo1Wryk2W1xD7Fim63W4CDwQDb7VYgw+EQ3W5XClD9fl/cC5Bzicfj0m4kEkHDnmer1RLHbNnj8QpwbDu4Xq/Y7XbicjweY2I7I4jn2WyGXC4HhYGUSiX4fD5xE41GBMyzYTjtekImrE4fn58OiG7F2WCI/u+Rfe4KmAEphNEqHWmaZgeiQ7W/dGcYOryhFPxmw25zhPv9hq+vL3F5v99xu90kHGq/3zuhhMNhcUcY3bg8fjtpl5O4puAj+QtGII5ep43v7x+Z4WKxwGazweFwEDiDoQRIh1wbXrgaVssJhSGZqSS84RQUVUffbpErQyBbZjDH41GgDOW9NtVqFVwdrghnxzuDCgaD8sbW6bxpFyKEegVBEOH/hJJOpwWk/Z0b76Zpvu8vINfLsiw0Go23GCjlrJsl6/cHmTM3eUS/47oAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img3' title='img3' src='/static/fe0781b8ad1359d3e25de8952645dc16/ca1dc/img3.png' srcset='/static/fe0781b8ad1359d3e25de8952645dc16/e7570/img3.png 170w,\n/static/fe0781b8ad1359d3e25de8952645dc16/f46e7/img3.png 340w,\n/static/fe0781b8ad1359d3e25de8952645dc16/ca1dc/img3.png 680w,\n/static/fe0781b8ad1359d3e25de8952645dc16/ef0cc/img3.png 962w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이렇게 상수 MEMBER와 CREATOR의 id가 모두 1로 바뀌었다. 디버깅을 해보니 실제로 상수의 id 값이 모두 1로 바뀐 것을 볼 수 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 491px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/3ff3d4f78422a9ad12390ae2d13ddceb/ca2ce/debug3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 65.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1klEQVQ4y5VT2XKcMBDcX/PGC4sOkEAgiWNvO+vj/187MwJTcVxOKg9Tw6Wenu5mkyuDwTu8RY+p9ahqB9O01Nt0LbTB417gR16k/q/aPGQCYyhwixWMcVC1hWosKldDmgqZFNiJr4DfDdhsc0kMBV56i+cuEkuHoa1RNQbSaei2hLAqAfxe3zJkwDHMgE8E+BYiRlpZmBLKlSiMJoYSu0IiEwoZdT64zfZfigetDJ+jSQxvPkCZGmXdJC2Nm7Xk6uKA4XBCaRvsFQ3TVep7qSFKkwaShjJp+LM3ePU9bp1PgAxgFzDrOtRtl/p4OsP3I+J0wOF8SQP66YjpdEFNZze5qpLLr7HD3Uf0BMLsPoCYIU8vmBGVJnY8UFY2MdW2TjU/M9g8FpoYVrgFYmXoA46Nm1flj3gN1ibpRP1hl6+a8fVay7N15TutPDaeplUoG2JCJWqNghzOtVpd3C2m/N1lLwlwjs17jLhSwDVlkGMjEqD8xOi/YnMPAZY1saQRBZx1EeQml0nm+OTsn3HZLvlcAZ/oT7mTy9dPLnerwwzEsTlernBkXtMFtHTPnd+x88rYGTC0gkyZc3imw2pxkEE/HOfSNIhB29AvmTwiDFO65+hYAv4F4sn084OChegAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='debug3' title='debug3' src='/static/3ff3d4f78422a9ad12390ae2d13ddceb/ca2ce/debug3.png' srcset='/static/3ff3d4f78422a9ad12390ae2d13ddceb/e7570/debug3.png 170w,\n/static/3ff3d4f78422a9ad12390ae2d13ddceb/f46e7/debug3.png 340w,\n/static/3ff3d4f78422a9ad12390ae2d13ddceb/ca2ce/debug3.png 491w' sizes='(max-width: 491px) 100vw, 491px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이 상태에서 처음 봤던 테스트 코드로 돌아가보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// CategoryServiceTest</span>\n\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"자신이 만들지 않은 카테고리를 수정할 경우 예외를 던진다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> 자신이_만들지_않은_카테고리를_수정할_경우_예외를_던진다<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Member</span> creator <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CREATOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 문제 발생 !!!</span>\n    <span class=\"token class-name\">CategoryResponse</span> savedCategory <span class=\"token operator\">=</span> categoryService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>creator<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryCreateRequest</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CATEGORY_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">CategoryUpdateRequest</span> categoryUpdateRequest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CategoryUpdateRequest</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MODIFIED_CATEGORY_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// when &amp; then</span>\n    <span class=\"token function\">assertThatThrownBy</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> categoryService<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> savedCategory<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> categoryUpdateRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isInstanceOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NoPermissionException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>테스트를 보면 처음으로 MEMBER를 저장한다. 이까지는 아무 문제가 없다. 문제는 두 번째로 CREATOR를 저장할 때 발생한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/9f2e3b2b9edcf5bcdccdfa2d633f28df/d7258/img4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 53.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACOklEQVQozzVTa3OaQBRFUdGoREkz9ZnR+IhaJSgGUWIV4iPW2FAwnYzm//+N0703zYczy12Ys+exSLquo9frIZFIQJIkRCJfiDBoj1AqldBoNHBzc4NKpcJrtVpl1Go1NJtN5PN5SDTQB0RIBHIsAVmOIRqNIhaLMYiw3+9jOp0iDEOcTicEQYDz+Yy3tzd4nsfviFzSNA2ZTAapVAqpZBLqZR6ZrIqkeKa9L+WdTgej0QjL5RLb7RabzQbr9Zoxm81gWRbK5TKk29tbFAoFltzpdqHrA9zd3aHdbqNer0NRFCY0DAOHwwGr1Qrj8RjD4ZAPINBs2/YnIeVSLBbZYjabZSWDwQCqqrLd5H/CB+uBrZLl+XzOBFOhjKzSs+M4HJ1E2ZAask0EuVwOmgiXrHJ+oiBNvoDxQ8fCXWIymcA0TZhCmTm2MH6wWSWRUlESWaUwSR2pjIpCImKVZRnxeJz3SvIlLPNT4X6/Z5Xv7+/4+PjgUo7HI3zf/yyFiNLptCCS2VpcueCmo3RtYlF8v8hBjSjQjXuEQYjNegPXdbHb7cQcwH/1sRa5UtNMSAqpFAqUgqf8qJSuKKhYLiGXSPNBRBgcQ7hPHozREM6jgz9hgN/+K9slMGGr1eJLS9eEcqSZCEm1Iva0tIpvior5vYVfMw8vzhP28xV2jofV5Ce29hJze8YFVakUUnd1dcUFUG40U+s8C6jJNLqXFTz3pjiY4g4aj/BHLg7DBf6O13gZLdgN/W3X19f4B6GvOfybXg1jAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img4' title='img4' src='/static/9f2e3b2b9edcf5bcdccdfa2d633f28df/ca1dc/img4.png' srcset='/static/9f2e3b2b9edcf5bcdccdfa2d633f28df/e7570/img4.png 170w,\n/static/9f2e3b2b9edcf5bcdccdfa2d633f28df/f46e7/img4.png 340w,\n/static/9f2e3b2b9edcf5bcdccdfa2d633f28df/ca1dc/img4.png 680w,\n/static/9f2e3b2b9edcf5bcdccdfa2d633f28df/d7258/img4.png 966w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>CREATOR를 저장하려고 하는데 저장된 MEMBER의 id도 1이고, CREATOR의 id도 1이다. CREATOR를 저장할 때 영속성 컨텍스트에 같은 id를 가진 entity가 있으므로 CREATOR를 새롭게 저장하지 않고, 기존의 id가 1번인 entity를 수정하게 된다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/0fc51556a4deff29f98d6be398f1bef4/ed282/img5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvUlEQVQoz42R227aUBBFD7EhFDvYQBxIQxOBiil3VHEz+FKuCYmJKpEi9YWq7f9/w6o5bp+ahzxszRnpaM2ePUIIwVuk6zqNTw3qdp1arYZdsyPV4rdt02g0KJfLp79vA5q5HOPJhPlizs/fv9h/e+H448jxeGS32+E4Ds1m83WgIs54p6Q4P0uSVpIkhUKxYOGOHXxnxsN8zX2wxHc9PM+TsNFoJJ2KXDS53+/Lpt1qyRWMtMaHCwsrY1LUclynTezSHTt3xYMzZ+ME7GYrZtGAwXAgYdMIWq/XEaqqYhgG6XQacZaIXapJRCJ2q6aScYbGhXTjRhpNxnweDRiMxwydKYPRkMnUkTmKTCYj3RUKBa40kzujyK1R4iZrca0XyOkGWiJFOV9k+7glDEMC12c9+8K9t2DjLVlMfVb+nNYpQ03TqFarEmj9BVYi4G32ipKex9SzZESSGwl85Cl8YuEGPLtrvnobWcPZkq2/jI9yAp4cWpeX8UEUhY/me0paXvap85SsWdPgZb/ncDjgBwHjaMUw2PB98SyP4/oe7XY7iiqRkJB/Ul95S2A2S7fbpdPp/K92h16vR6VS4Q+zYPZhTr53xgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='img5' title='img5' src='/static/0fc51556a4deff29f98d6be398f1bef4/ca1dc/img5.png' srcset='/static/0fc51556a4deff29f98d6be398f1bef4/e7570/img5.png 170w,\n/static/0fc51556a4deff29f98d6be398f1bef4/f46e7/img5.png 340w,\n/static/0fc51556a4deff29f98d6be398f1bef4/ca1dc/img5.png 680w,\n/static/0fc51556a4deff29f98d6be398f1bef4/ed282/img5.png 964w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>기존의 값이 수정되니 id가 1번인, MEMBER를 저장한 member instance의 값까지 변경되는 것이다.</p>\n<h2>해결</h2>\n<p>Entity 객체에 대한 fixture가 필요한 경우 객체를 생성하는 메서드를 통해 호출할 때마다 새로운 객체를 생성해서 반환하도록 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Member</span> 파랑<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span>파랑_이메일<span class=\"token punctuation\">,</span> 파랑_프로필<span class=\"token punctuation\">,</span> 파랑_이름<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>결론</h2>\n<p>상수란 변하지 않고 고정된 값을 담는 변수를 의미한다. 하지만 우리는 필드가 변하는 객체인 Member Entity를 상수로 선언했다. 테스트 격리를 아무리 잘 해도 상수까지 계속 리프레쉬 해주진 않기 때문에 이런 문제가 발생한 것이다.</p>\n<p><strong>변하지 않는 불변 객체만 상수로 지정하자!!</strong></p>","frontmatter":{"title":"테스트에서 Entity 객체를 상수로 두면 안 되는 이유","date":"July 27, 2022","update":"July 27, 2022","tags":["Spring","test fixture","상수"],"series":null},"fields":{"slug":"/test-fixture-constant/","readingTime":{"minutes":5.185}}},"seriesList":{"edges":[{"node":{"id":"a621dc7b-8590-5ec6-9b52-3d9e5182486d","fields":{"slug":"/appearance-background-of-jpa/"},"frontmatter":{"title":"JPA 등장배경"}}},{"node":{"id":"9d2a87b6-2b9c-5b87-b790-3426d17c2d8e","fields":{"slug":"/intellij-final-keyword/"},"frontmatter":{"title":"IntelliJ에서 메소드 추출한 메소드의 파라미터에 final 키워드 자동 추가하기"}}},{"node":{"id":"251e9767-1c92-5cf5-9cef-2c4a42c10df2","fields":{"slug":"/git-branch-strategy/"},"frontmatter":{"title":"달록팀의 git 브랜치 전략을 소개합니다."}}},{"node":{"id":"5090cce3-0c1f-5376-badc-1d25e44c1bd9","fields":{"slug":"/infinite-scroll/"},"frontmatter":{"title":"React에서 무한 스크롤 구현하기"}}},{"node":{"id":"bcb53ba5-0286-5d10-96c2-fdcb88e2cc60","fields":{"slug":"/package-structure/"},"frontmatter":{"title":"달록에 적절한 패키지 구조 고민하기"}}},{"node":{"id":"a7fc89de-f37c-596e-a81d-3d4fe5a795b8","fields":{"slug":"/data-jpa-slice-page/"},"frontmatter":{"title":"Spring Data JPA의 Slice & Page"}}},{"node":{"id":"e1ba92ee-0cf0-50c8-80bd-5da5075df8d1","fields":{"slug":"/data-jpa-auditing/"},"frontmatter":{"title":"Spring Data JPA의 Auditing"}}},{"node":{"id":"3e036508-c916-504e-9e8d-89f69332471e","fields":{"slug":"/separated-interface/"},"frontmatter":{"title":"외부와 의존성 분리하기"}}},{"node":{"id":"cade544a-16ef-58a3-b97c-824986a8395f","fields":{"slug":"/apply-rest-docs/"},"frontmatter":{"title":"MockMvc를 사용한 Spring RestDocs"}}},{"node":{"id":"87649d54-d59e-58a6-afd5-8491eb4113a8","fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}}},{"node":{"id":"eb380f6d-5a00-5a9e-a916-003fb292cc8a","fields":{"slug":"/test-fixture-constant/"},"frontmatter":{"title":"테스트에서 Entity 객체를 상수로 두면 안 되는 이유"}}},{"node":{"id":"9734e30a-b430-5922-919d-f53808a56eb9","fields":{"slug":"/what_is_nginx/"},"frontmatter":{"title":"NGINX 란?"}}},{"node":{"id":"9ebc6e21-2a76-5d42-be33-c2dae8c849b2","fields":{"slug":"/ssl_protocol/"},"frontmatter":{"title":"SSL을 통한 HTTPS통신 과정"}}},{"node":{"id":"fa5ad595-1f81-5a20-a884-2da69adee3c5","fields":{"slug":"/integration-test-slice-test/"},"frontmatter":{"title":"통합 테스트와 슬라이스 테스트"}}},{"node":{"id":"d8c66823-bb05-5e83-a6a1-2fd9af450b6f","fields":{"slug":"/query-invalidation/"},"frontmatter":{"title":"React-Query에서의 데이터 최신화 (Query Invalidation)"}}},{"node":{"id":"f5187517-342f-52a1-9092-d12c1a80d132","fields":{"slug":"/seperate-components/"},"frontmatter":{"title":"컴포넌트 분리 기준"}}},{"node":{"id":"d6249c8b-bea6-5c91-8477-d3dd15ad9b39","fields":{"slug":"/test-isolation/"},"frontmatter":{"title":"테스트 격리"}}},{"node":{"id":"98e390ef-fb19-5d01-a3ef-d14bc0e65176","fields":{"slug":"/dallog-jacoco/"},"frontmatter":{"title":"달록의 Jacoco 적용기 (feat. Gradle)"}}},{"node":{"id":"33d19946-de0c-5b41-bfa0-d7c3fd80f10b","fields":{"slug":"/google-refresh-token/"},"frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다."}}},{"node":{"id":"8168857d-a82c-5608-bd40-cea4b917d17d","fields":{"slug":"/submodule/"},"frontmatter":{"title":"달록 서브모듈 도입기"}}},{"node":{"id":"836fc724-7e2f-5c7a-a42b-c0cc9163167a","fields":{"slug":"/dallog-flyway/"},"frontmatter":{"title":"달록의 데이터베이스 마이그레이션을 위한 Flyway 적용기"}}},{"node":{"id":"7a3bde6d-746b-56fd-8d91-0d8059ebf1f8","fields":{"slug":"/json-property-json-naming/"},"frontmatter":{"title":"@JsonProperty, @JsonNaming"}}},{"node":{"id":"50673f5c-f835-5982-b70c-b77e5a352a2c","fields":{"slug":"/servlet-life-cycle/"},"frontmatter":{"title":"서블릿 생명주기와 직접만든 톰캣을 통한 의문점"}}},{"node":{"id":"61e7f4d1-7b3a-5968-bfe8-c3f6efb88748","fields":{"slug":"/preparing-for-performance-test/"},"frontmatter":{"title":"톰캣 튜닝을 위한 달록의 서버 성능 테스트 준비 과정"}}},{"node":{"id":"9272061d-68c6-5f82-a961-0e2efe0fd6be","fields":{"slug":"/cyclic-dependency/"},"frontmatter":{"title":"cyclic dependency"}}},{"node":{"id":"6e779308-f266-58af-bfcc-e9fee6d39a98","fields":{"slug":"/multi-datasource-issue-with-osiv/"},"frontmatter":{"title":"대체 왜 DataSource 라우팅이 안되는거야!? (feat. OSIV)"}}},{"node":{"id":"0e63245e-c52c-5977-9f60-f94ee0fd00fc","fields":{"slug":"/hikari-cp-theory/"},"frontmatter":{"title":"HikariCP와 적절한 풀 사이즈 고민하기 (이론편)"}}},{"node":{"id":"c7bea043-345c-5f78-ae53-796a83812961","fields":{"slug":"/react-query-useMutation-trouble-shooting/"},"frontmatter":{"title":"react-query useMutation onSuccess 안 되는줄 알았던 트러블 슈팅"}}}]},"previous":{"fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}},"next":{"fields":{"slug":"/what_is_nginx/"},"frontmatter":{"title":"NGINX 란?"}}},"pageContext":{"id":"eb380f6d-5a00-5a9e-a916-003fb292cc8a","series":null,"previousPostId":"87649d54-d59e-58a6-afd5-8491eb4113a8","nextPostId":"9734e30a-b430-5922-919d-f53808a56eb9"}},"staticQueryHashes":[]}