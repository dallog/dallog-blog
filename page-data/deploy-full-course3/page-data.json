{"componentChunkName":"component---src-templates-post-jsx","path":"/deploy-full-course3/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"ba13f1c5-fc6b-5f19-afbc-ea2bc164b7ee","excerpt":"이 글은 우테코 달록팀 크루 파랑이 작성했습니다. NGINX 설치 NGINX란? 달록 기술블로그 - 리버의 NGINX 란? 설치 SSL 인증서 발급 (with Certbot) Let’s Encrypt 90일짜리 단기 인증서를 무료로 발급해주는 곳입니다. 주기적으로 재발급 해줘야 합니다. Snapd 설치 snapcraft 공식문서 - Installing s…","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 <a href=\"https://github.com/summerlunaa\">파랑</a>이 작성했습니다.</p>\n</blockquote>\n<h2>NGINX 설치</h2>\n<h3>NGINX란?</h3>\n<p><a href=\"https://dallog.github.io/what_is_nginx/\">달록 기술블로그 - 리버의 NGINX 란?</a></p>\n<h3>설치</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update <span class=\"token comment\"># 운영체제에서 사용 가능한 패키지들과 그 버전에 대한 정보(리스트) 업데이트 </span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> nginx -y <span class=\"token comment\"># nginx 설치</span>\n$ nginx -v <span class=\"token comment\"># 설치한 nginx 버전 확인</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx status <span class=\"token comment\"># nginx 상태 확인</span></code></pre></div>\n<h2>SSL 인증서 발급 (with Certbot)</h2>\n<h3>Let’s Encrypt</h3>\n<p>90일짜리 단기 인증서를 무료로 발급해주는 곳입니다. 주기적으로 재발급 해줘야 합니다.</p>\n<h3>Snapd 설치</h3>\n<p><a href=\"https://snapcraft.io/docs/installing-snap-on-ubuntu\">snapcraft 공식문서 - Installing snap on Ubuntu</a></p>\n<p>certbot은 snapd로 certbot을 설치하는 것을 권장하고 있습니다. 리눅스 통합 패키지 관리 툴인 snapd를 먼저 설치해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> snapd</code></pre></div>\n<h3>Certbot 설치</h3>\n<p><a href=\"https://certbot.eff.org/instructions?ws=apache&#x26;os=centosrhel7\">certbot 공식 문서 - certbot 설치</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> snap <span class=\"token function\">install</span> core<span class=\"token punctuation\">;</span> \n$ <span class=\"token function\">sudo</span> snap <span class=\"token function\">install</span> --classic certbot <span class=\"token comment\"># certbot 설치</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s /snap/bin/certbot /usr/bin/certbot <span class=\"token comment\"># certbot 명령어를 사용하기 위해 심볼릭링크 걸기</span>\n$ certbot --version <span class=\"token comment\"># 버전 확인</span></code></pre></div>\n<h3>SSL 인증서 발급 방법</h3>\n<p><a href=\"https://eff-certbot.readthedocs.io/en/stable/using.html#apache\">certbot 공식 문서 - 인증서 발급 방법</a></p>\n<p>Certbot을 통해 SSL 인증서를 발급받는 방법은 여러가지가 있습니다. 그 중 몇 가지를 간단하게 살펴볼게요. 달록은 Nginx 방법을 사용했습니다.</p>\n<ul>\n<li>\n<p><strong><code class=\"language-text\">Nginx</code></strong> (우리가 사용한 방법)</p>\n<ul>\n<li>인증 및 설치를 위해 nginx 플러그인을 사용한다. nginx에 대한 인증서 취득 및 설치가 자동적으로 이루어진다.</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">Webroot</code></p>\n<ul>\n<li>기능이 동작하고 있는 로컬 웹 서버를 실행 중이라면 웹 서버를 중지하면 안 되는 경우가 있다. 그런 경우 webroot 방식을 사용할 수 있다.</li>\n<li>웹의 디렉토리 내에 인증서의 유효성을 확인할 수 있는 임시 파일을 만들어 인증을 진행한다.</li>\n<li>한 번에 하나의 도메인만 발급 가능하다.</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">Standalone</code></p>\n<ul>\n<li>인증서 발급을 위해 기존의 웹 서버를 중지해야 한다.</li>\n<li>인증을 위해 80 포트로 가상의 standalone 웹서버를 띄워 인증서를 발급한다.</li>\n<li>한 번에 여러 도메인을 발급할 수 있다.</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">Manual</code></p>\n<ul>\n<li>도메인의 유효성 검증을 직접 수행하는 경우 사용한다.</li>\n<li>디렉토리에 특정 이름과 특정 내용을 가진 임시 파일을 만들어야 한다. webroot 방식과 비슷하지만 자동으로 진행되지 않는다.</li>\n<li>\n<p>도메인에 <code class=\"language-text\">_acme-challenge</code> 를 붙인 TXT DNS 레코드를 설정해주어야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 예시</span>\n_acme-challenge.example.com. <span class=\"token number\">300</span> IN TXT <span class=\"token string\">\"gfj9Xq...Rg85nM\"</span></code></pre></div>\n</li>\n</ul>\n</li>\n</ul>\n<h3>인증서 발급하기</h3>\n<p>그럼 이제 Nginx 방법을 사용해서 인증서를 발급받아 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> certbot certonly --nginx -d <span class=\"token punctuation\">{</span>도메인 이름<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">certonly</code></p>\n<ul>\n<li>자동으로 nginx 설정을 수정하지 않고 인증서만 발급받는 옵셥입니다. 자동으로 어떻게 설정되는지 확실히 알지 못하는 경우엔 certonly로 받는 것이 나을 수 있습니다.</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">—-nginx</code></p>\n<ul>\n<li>nginx 방식을 활용하겠다는 의미입니다.</li>\n</ul>\n</li>\n</ul>\n<h3>Nginx 설정</h3>\n<p>이제 nginx 설정을 위해서 설정 파일을 생성합니다. <code class=\"language-text\">/etc/nginx/conf.d</code> 디렉토리로 이동하여 <code class=\"language-text\">default.conf</code> 파일을 생성합니다. 꼭 sudo로 명령어를 입력해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token builtin class-name\">cd</span> /etc/nginx/conf.d\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> default.conf</code></pre></div>\n<blockquote>\n<p>⚠️ 주의: <code class=\"language-text\">sites-available</code> 과 <code class=\"language-text\">sites-enabled</code> 는 더 이상 사용되지 않는 nginx 설정 방법입니다.</p>\n</blockquote>\n<p><code class=\"language-text\">sites-available</code> 과 <code class=\"language-text\">sites-enabled</code> 두 디렉토리는 sym link로 연결되어 있습니다. 기존 방식은 <code class=\"language-text\">sites-available</code>에 여러 설정파일들을 때려 박은 다음에 <code class=\"language-text\">sites-enabled</code>에 원하는 설정을 선택적으로 동기화하는 방식입니다. 이는 비효율적인 방법이므로 더 이상 사용되지 않는다고 합니다.</p>\n<p><strong>따라서 <code class=\"language-text\">sites-available</code> 에 기본 설정 파일이 있다면 제거해줍시다.</strong></p>\n<br>\n<p><code class=\"language-text\">default.conf</code> 파일을 생성했다면 아래와 같이 내용을 적어줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># dallog-frontend /etc/nginx/conf.d/default.conf</span>\n\n<span class=\"token comment\"># 80 포트로 요청이 오는 경우 https가 적용된 url로 redirect 한다.</span>\nserver <span class=\"token punctuation\">{</span>\n  listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  server_name dallog.me<span class=\"token punctuation\">;</span>\n\n  <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> https://dallog.me<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 443 포트로 요청이 오는 경우</span>\nserver <span class=\"token punctuation\">{</span>\n  listen <span class=\"token number\">443</span> ssl http2<span class=\"token punctuation\">;</span>\n  server_name dallog.me<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\"># SSL 인증을 위한 pem key 위치를 설정한다.</span>\n  ssl_certificate /etc/letsencrypt/live/dallog.me/fullchain.pem<span class=\"token punctuation\">;</span>\n  ssl_certificate_key /etc/letsencrypt/live/dallog.me/privkey.pem<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\"># front의 경우 정적 페이지를 보여주기 위해 index.html 위치를 설정한다.</span>\n  location / <span class=\"token punctuation\">{</span>\n    root /usr/share/nginx/html<span class=\"token punctuation\">;</span>\n    index index.html<span class=\"token punctuation\">;</span>\n    try_files <span class=\"token variable\">$uri</span> <span class=\"token variable\">$uri</span>/ /index.html<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># dallog-ws /etc/nginx/conf.d/default.conf</span>\n\nserver <span class=\"token punctuation\">{</span>\n  listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n  server_name api.dallog.me<span class=\"token punctuation\">;</span>\n\n  <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> https://api.dallog.me<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nserver <span class=\"token punctuation\">{</span>\n  listen <span class=\"token number\">443</span> ssl http2<span class=\"token punctuation\">;</span>\n  server_name api.dallog.me<span class=\"token punctuation\">;</span>\n\n  ssl_certificate /etc/letsencrypt/live/api.dallog.me/fullchain.pem<span class=\"token punctuation\">;</span>\n  ssl_certificate_key /etc/letsencrypt/live/api.dallog.me/privkey.pem<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\"># web server의 경우 리버스 프록시를 위한 proxy 설정이 들어간다.</span>\n  location / <span class=\"token punctuation\">{</span>\n    proxy_pass http://<span class=\"token punctuation\">{</span>backend-prod server ip<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># backend-prod server ip</span>\n    proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n    proxy_set_header X-Forwarded-Proto <span class=\"token variable\">$scheme</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">proxy_pass</code> : 프록시 주소, 백엔드 운영 서버 ip를 넣어준다.</li>\n<li><code class=\"language-text\">proxy_set_header Host $http_host</code> : HTTP Request의 Host 헤더 값, 클라이언트가 요청한 원래 호스트 주소</li>\n<li><code class=\"language-text\">X-Real-IP $remote_addr</code>: 실제 방문자의 원격 ip 주소</li>\n<li><code class=\"language-text\">X-Forwarded-For $proxy_add_x_forwared_for</code> : 클라이언트가 프록시 처리한 모든 서버의 IP 주소를 포함하는 목록</li>\n<li><code class=\"language-text\">X-forwarded-Proto $scheme</code> : HTTP의 구조로 http or https를 의미한다. HTTPS 서버 블록 내에서 사용할 경우 프록시 서버의 HTTP 응답이 HTTPS로 변환된다.</li>\n</ul>\n<h3>Nginx 설정 이후 재시작</h3>\n<p>설정을 끝냈다면 적용을 위해 Nginx를 재시작 해주어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># nginx 재시작, 둘 중 하나 선택</span>\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx reload\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx restart</code></pre></div>\n<h2>인증서 발급 시 발생할 수 있는 에러</h2>\n<p>인증서 발급 시 발생할 수 있는 에러들을 알아봅시다. 아래 두 가지 에러는 실제로 달록이 SSL 인증서를 발급받는 과정에서 겪은 에러입니다.</p>\n<h3>1. too many failed authorizations recently</h3>\n<p><a href=\"https://letsencrypt.org/docs/failed-validation-limit/\">Let's encrypt 공식 문서 - failed validation limit</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> certbot certonly --nginx -d api.dallog.me\n\nSaving debug log to /var/log/letsencrypt/letsencrypt.log\nRequesting a certificate <span class=\"token keyword\">for</span> api.dallog.me\nAn unexpected error occurred:\nError creating new order :: too many failed authorizations recently: see https://letsencrypt.org/docs/failed-validation-limit/\nAsk <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span> or search <span class=\"token keyword\">for</span> solutions at https://community.letsencrypt.org. See the logfile /var/log/letsencrypt/letsencrypt.log or re-run Certbot with -v <span class=\"token keyword\">for</span> <span class=\"token function\">more</span> details.</code></pre></div>\n<p>이 오류는 계정, 호스트 네임, 시간당 5번의 유효성 검사 실패시 발생합니다. 몇 시간(3-4시간 정도) 기다리면 제한이 풀립니다. 그 때 다시 시도하면 됩니다.</p>\n<h3>2. too many certificates</h3>\n<p><a href=\"https://letsencrypt.org/docs/duplicate-certificate-limit/\">Let's encrypt 공식 문서 - duplicate certificate limit</a></p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/35e6869a39f68ee5c9daceb01252b1b0/f28c3/error.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 19.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVQY01WQW26DMBBFWUaoQiUamgqKbWzzKgQoLeSpdP+7ublY5KMfR2fsGY899vLrDdl8hpqOSMcZyXCD+PmDGO9I+zNEf4TsT4ibX0RFh9C0eMsPjn014DWrsfm08NMcPu3ZeoSuvqHKAZKoskdM9mWHQBSOLYsX/MT8YxNr5xc2CtYaT+sapWlg9JdD8UZJSzqjNXO5bZ0LesGsWL7SEM1YMB/xjKc4juRYah1NHCak7eS87IludvFzbccLPjjqjk0iNnvnNyxxyDikH7GZgDUmjHZuAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='error' title='error' src='/static/35e6869a39f68ee5c9daceb01252b1b0/ca1dc/error.png' srcset='/static/35e6869a39f68ee5c9daceb01252b1b0/e7570/error.png 170w,\n/static/35e6869a39f68ee5c9daceb01252b1b0/f46e7/error.png 340w,\n/static/35e6869a39f68ee5c9daceb01252b1b0/ca1dc/error.png 680w,\n/static/35e6869a39f68ee5c9daceb01252b1b0/02d09/error.png 1020w,\n/static/35e6869a39f68ee5c9daceb01252b1b0/9d567/error.png 1360w,\n/static/35e6869a39f68ee5c9daceb01252b1b0/f28c3/error.png 1424w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>문제는 이 두 번째 에러입니다. 이 오류는 주당 5번이라는 인증서 발급 횟수 제한을 넘긴 경우 발생합니다. 이 경우 일주인간 인증서 발급이 제한됩니다(…🥲). 이 오류를 피하기 위해서는 인증서를 재발급 받는 대신 pem key를 복사해서 사용해야 합니다. <strong>재발급은 신중히 받도록 합시다.</strong></p>\n<h2>기타 인증서 관련 명령어</h2>\n<h3>인증서 자동 갱신</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> certbot renew --dry-run</code></pre></div>\n<h3>인증서 삭제</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ certbot delete --cert-name <span class=\"token punctuation\">{</span>인증서 이름<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n \n#### reference\n<p><a href=\"https://hudi.blog/https-with-nginx-and-lets-encrypt/\">후디 블로그 - Nginx와 Let's Encrypt로 HTTPS 웹 서비스 배포하기 (feat. Certbot)</a>\n<a href=\"https://velog.io/@jihyunhillpark/2.-spring-boot-%EA%B8%B0%EB%B0%98-%EC%95%B1-%EB%B0%B0%ED%8F%AC-Cerbot-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EB%B0%9C%EA%B8%89%EA%B3%BC-SSL-%EC%A0%81%EC%9A%A9\">2. Nginx 설치 부터 spring boot 기반 앱 배포 - Cerbot 인증서 발급과 SSL 적용</a>\n<a href=\"https://blog.naver.com/PostView.naver?blogId=kangdydtjs&#x26;logNo=222546308110&#x26;from=search&#x26;redirect=Log&#x26;widgetTypeCall=true&#x26;directAccess=false\">4. SSL 인증서(letsencrypt) 발급</a></p>\n<h4>Special Thanks To <code class=\"language-text\">승팡</code></h4>","frontmatter":{"title":"달록 배포 총🔫정리 3 - SSL 인증서 발급과 NGINX 설정","date":"August 08, 2022","update":"August 08, 2022","tags":["deploy","DevOps"],"series":"달록 배포 총🔫정리"},"fields":{"slug":"/deploy-full-course3/","readingTime":{"minutes":9.3}}},"seriesList":{"edges":[{"node":{"id":"5a96e346-8893-537d-b35c-811304ffa4ce","fields":{"slug":"/deploy-full-course1/"},"frontmatter":{"title":"달록 배포 총🔫정리 1 - 전체적인 구조 살펴보기"}}},{"node":{"id":"8bc0402c-3e53-5b2f-8b5d-155b47d70fae","fields":{"slug":"/deploy-full-course2/"},"frontmatter":{"title":"달록 배포 총🔫정리 2 - EC2와 DNS 설정하기"}}},{"node":{"id":"ba13f1c5-fc6b-5f19-afbc-ea2bc164b7ee","fields":{"slug":"/deploy-full-course3/"},"frontmatter":{"title":"달록 배포 총🔫정리 3 - SSL 인증서 발급과 NGINX 설정"}}}]},"previous":{"fields":{"slug":"/deploy-full-course2/"},"frontmatter":{"title":"달록 배포 총🔫정리 2 - EC2와 DNS 설정하기"}},"next":null},"pageContext":{"id":"ba13f1c5-fc6b-5f19-afbc-ea2bc164b7ee","series":"달록 배포 총🔫정리","previousPostId":"8bc0402c-3e53-5b2f-8b5d-155b47d70fae","nextPostId":null}},"staticQueryHashes":[]}