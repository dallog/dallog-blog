{"componentChunkName":"component---src-templates-post-jsx","path":"/circular-reference-1/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"58c190f3-6af7-5fd7-8cdb-dc3519296e42","excerpt":"이 글은 우테코 달록팀 크루 '매트'가 작성했습니다. 순환 참조란, 서로 다른 여러 빈이 상호 간의 의존성을 가져 의존성이 순환하고 있다는 것을 의미한다. 예를 들면 아래와 같은 상황이다. 우리 달록은 Member가 생성되는 시점에 개인의 일정을 저장하기 위한 Category와 개인 Cateogry에 대한 Subscription 정보가 추가되어야 하는 요…","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 '<a href=\"https://github.com/hyeonic\">매트</a>'가 작성했습니다.</p>\n</blockquote>\n<p>순환 참조란, 서로 다른 여러 빈이 상호 간의 의존성을 가져 의존성이 순환하고 있다는 것을 의미한다. 예를 들면 아래와 같은 상황이다.</p>\n<p>우리 달록은 Member가 생성되는 시점에 개인의 일정을 저장하기 위한 Category와 개인 Cateogry에 대한 Subscription 정보가 추가되어야 하는 요구사항을 가지고 있다. 이것을 코드로 표현하면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MY_SCHEDULE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"내 일정\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CategoryService</span> categoryService<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 순환 참조</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SubscriptionService</span> subscriptionService<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">MemberService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">CategoryService</span> categoryService<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SubscriptionService</span> subscriptionService<span class=\"token punctuation\">,</span>\n                         <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>categoryService <span class=\"token operator\">=</span> categoryService<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>subscriptionService <span class=\"token operator\">=</span> subscriptionService<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> displayName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> newMember <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> displayName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Category</span> newCategory <span class=\"token operator\">=</span> categoryService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>newMember<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">MY_SCHEDULE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        subscriptionService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>newMember<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> newCategory<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> newMember<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NoSuchElementException</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>앞서 언급한 것처럼 Member 생성 시 아래와 같이 내 일정을 저장하기 위한 Category와 내 일정을 바로 Subscription 하기 위한 로직이 필요하다. 즉 <code class=\"language-text\">MemberService</code>는 <code class=\"language-text\">CategoryService</code>와 <code class=\"language-text\">SubscriptionService</code>를 필드로 가지며 <code class=\"language-text\">의존</code>하는 형태를 띄게 된다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CategoryService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberService</span> memberService<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 순환 참조</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CategoryRepository</span> categoryRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CategoryService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberService</span> memberService<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CategoryRepository</span> categoryRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberService <span class=\"token operator\">=</span> memberService<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>categoryRepository <span class=\"token operator\">=</span> categoryRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Category</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberService<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Category</span> newCategory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Category</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> categoryRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>newCategory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Category</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> categoryRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NoSuchElementException</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드는 Category 저장을 위한 로직을 담은 <code class=\"language-text\">CategoryService</code>이다. <code class=\"language-text\">CategoryService</code>의 경우 요청된 <code class=\"language-text\">Member Id</code> 정보를 기반으로 Member를 조회한 뒤 Category를 저장하게 된다.</p>\n<p>이러한 구조 덕분에 <code class=\"language-text\">MemberService</code>는 <code class=\"language-text\">CategoryService</code>를 의존하고, <code class=\"language-text\">CategoryService</code>는 <code class=\"language-text\">MemberService</code>를 의존하게 되어 <code class=\"language-text\">순환 참조</code>가 발생하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">***************************\nAPPLICATION FAILED TO START\n***************************\n\nDescription:\n\nThe dependencies of some of the beans <span class=\"token keyword\">in</span> the application context form a cycle:\n\n┌─────┐\n<span class=\"token operator\">|</span>  categoryService defined <span class=\"token keyword\">in</span> <span class=\"token function\">file</span> <span class=\"token punctuation\">[</span>/Users/hyeonic/study/blog-code/circular-reference/build/classes/java/main/io/github/hyeonic/circularreference/category/CategoryService.class<span class=\"token punctuation\">]</span>\n↑     ↓\n<span class=\"token operator\">|</span>  memberService defined <span class=\"token keyword\">in</span> <span class=\"token function\">file</span> <span class=\"token punctuation\">[</span>/Users/hyeonic/study/blog-code/circular-reference/build/classes/java/main/io/github/hyeonic/circularreference/member/MemberService.class<span class=\"token punctuation\">]</span>\n└─────┘\n\n\nAction:\n\nRelying upon circular references is discouraged and they are prohibited by default. Update your application to remove the dependency cycle between beans. As a last resort, it may be possible to <span class=\"token builtin class-name\">break</span> the cycle automatically by setting spring.main.allow-circular-references to true.</code></pre></div>\n<h2>의존성 살펴보기</h2>\n<p>객체가 다른 객체의 의존성을 가진다는 것은 해당 객체의 변화에 직접적인 영향을 받을 수 있다는 것이다. 위 예시를 다시 한번 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MemberService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MY_SCHEDULE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"내 일정\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CategoryService</span> categoryService<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 순환 참조</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> displayName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> newMember <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Member</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> displayName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Category save 메서드의 시그니처나 반환 타입이 변경 된다면..?</span>\n        <span class=\"token class-name\">Category</span> newCategory <span class=\"token operator\">=</span> categoryService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>newMember<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">MY_SCHEDULE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        subscriptionService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>newMember<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> newCategory<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> newMember<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약 Category에 대한 요구사항이 변경되어 <code class=\"language-text\">save</code> 메서드의 시그니처나 반환 타입에 대한 변경에 <code class=\"language-text\">MemberService</code>는 직접적인 코드 수정으로 변화에 대응해야 한다.</p>\n<p>그만큼 객체가 객체를 의존한다는 것은 의존 객체의 변경에 영향을 받을 수 있다는 것을 의미한다. 이러한 의존이 순환되어 연결되어 있다고 생각해보자. 순환 참조에 해당하는 객체 모두 연쇄적으로 변경에 영향을 받을 수 있다는 것을 의미한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 677px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/c384cf87bde8cc0bdb5ee6b38dc3b33a/3c503/circular-reference.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 44.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmUlEQVQoz3VSaW/CMBTr//9TsINNoE18KB0DBgN6pVdKoTCONp5fNqZp0iJZaZoX28+Jk754GN3ewCUWz09AtcE5UQhHLpLXsZ1rfwVsSjRZgiZPAV3gY7nA8XjE+XzG6XTC4XCADGe7ekcUxwiCALos0RqDTreLotAotEa932MyneKDh69jV9dQ/hpT/vdoaDweI4oi5HkOB6X+Kax3Oyil4Pu+RRxHCMMQioJ5niFJEuwpIPPpcoHneej1euh0OihpRkidmkprHl4ul3BdF1p/CbRta9E0jV1Le+KoS/fi6PHujl0UyLLMOospKmKOXswtiWzKEEeGbf8dckhy2m63qIjJwz1aiv0WtRnuQ7bGNvv9PgaDAaqqshtSJMTXYiEbDoe2kzRNsVm8gQW4SkutwDG6+GEXdcknoEu5pJCZyPeIWSnJ7/smLQFv29Cd+UVmCdtUwTBgAf0TDebMKlivEAc+kijEA/O67hs+E0PXTRz+Q8i31aZElqLhbIoMlySGns9QvTPftxnXCuB/2W/pzNYL4R8ywSdxrqljij2pxwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='circular reference' title='circular reference' src='/static/c384cf87bde8cc0bdb5ee6b38dc3b33a/3c503/circular-reference.png' srcset='/static/c384cf87bde8cc0bdb5ee6b38dc3b33a/e7570/circular-reference.png 170w,\n/static/c384cf87bde8cc0bdb5ee6b38dc3b33a/f46e7/circular-reference.png 340w,\n/static/c384cf87bde8cc0bdb5ee6b38dc3b33a/3c503/circular-reference.png 677w' sizes='(max-width: 677px) 100vw, 677px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>사실 순환 참조를 해결하기 위한 방법으로는 <code class=\"language-text\">@Lazy</code> 애노테이션을 활용하거나 <code class=\"language-text\">setter</code> 주입을 사용하는 등 다양한 방법이 존재한다. 하지만 결국 이러한 순환 참조를 야기하는 설계는 근본적으로 각 객체에 대한 책임이 적절하지 않다는 의미를 내포할 수 있다. </p>\n<p>다음 시간에는 앞서 발생한 순환 참조를 달록에서 어떻게 개선하고 있는지 시리즈로 작성할 예정이다.</p>","frontmatter":{"title":"순환 참조 문제 개선기 (1)","date":"September 10, 2022","update":"September 10, 2022","tags":["매트","BE","순환 참조","circular reference","의존성","트러블 슈팅"],"series":"순환 참조 문제 개선기"},"fields":{"slug":"/circular-reference-1/","readingTime":{"minutes":4.87}}},"seriesList":{"edges":[{"node":{"id":"58c190f3-6af7-5fd7-8cdb-dc3519296e42","fields":{"slug":"/circular-reference-1/"},"frontmatter":{"title":"순환 참조 문제 개선기 (1)"}}}]},"previous":{"fields":{"slug":"/json-property-json-naming/"},"frontmatter":{"title":"@JsonProperty, @JsonNaming"}},"next":null},"pageContext":{"id":"58c190f3-6af7-5fd7-8cdb-dc3519296e42","series":"순환 참조 문제 개선기","previousPostId":"7a3bde6d-746b-56fd-8d91-0d8059ebf1f8","nextPostId":null}},"staticQueryHashes":[]}