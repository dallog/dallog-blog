{"componentChunkName":"component---src-templates-post-jsx","path":"/dallog-flyway/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"836fc724-7e2f-5c7a-a42b-c0cc9163167a","excerpt":"Flyway 란? Flyway는 오픈소스 데이터베이스 마이그레이션 툴 입니다. 데이터베이스 마이그레이션 툴이란 데이터베이스의 변경 사항을 추적하고, 업데이트나 롤백을 보다 쉽게 할 수 있도록 도와주는 도구입니다. 데이터베이스 마이그레이션을 왜 해야할까요?  프로젝트를 진행하다 보면, 데이터베이스가 위 그림처럼 여러 환경에서 존재하게 됩니다. 각자의 로컬 …","html":"<h2>Flyway 란?</h2>\n<p>Flyway는 오픈소스 <strong>데이터베이스 마이그레이션 툴</strong> 입니다. 데이터베이스 마이그레이션 툴이란 데이터베이스의 <strong>변경 사항을 추적하고, 업데이트나 롤백을 보다 쉽게</strong> 할 수 있도록 도와주는 도구입니다.</p>\n<p>데이터베이스 마이그레이션을 왜 해야할까요?</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b0ad961dd38e43cd4fb0f2ce113a54e5/9d62a/flyway.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 41.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNElEQVQoz31S2WrDMBDU/3+SHwPpkx+TFFJiE9+3fLaxnWS6s9ASStIBIbOSZmdmbbzTCb7nIU0SVFWNZVlAXC4XzPOs+/V6xf1+f7qIn50waZpiv9uhyHO0bYssy3A+n5HEsTYKgwBd1+EVHkm5zDCO2Gw2KMtSFd1uN/mu0NQ13g8H1FUlyitM06ee8c6yrOrkmWKTiTKqJOE4TVoshYBWHcdB3/eqsCgKHI9HxFGEKAxlj7XBX5hILjC/PMv1US4NQqmRiMpINkkjwjZWyT6EmHcZTy1O+IaRWWthmFUgmbFA0nVdn2bFwcxi0/d9jYjq6CIIQvgnTzkSUW2GYcDbdquDINmriRKj5G1ti6ZpZICd1ud5QS8u2IT5Gh6SjPbGcfrN5fFX+A+Mg7Zd18WXKP4GRVhkakedmaIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='flyway' title='flyway' src='/static/b0ad961dd38e43cd4fb0f2ce113a54e5/ca1dc/flyway.png' srcset='/static/b0ad961dd38e43cd4fb0f2ce113a54e5/e7570/flyway.png 170w,\n/static/b0ad961dd38e43cd4fb0f2ce113a54e5/f46e7/flyway.png 340w,\n/static/b0ad961dd38e43cd4fb0f2ce113a54e5/ca1dc/flyway.png 680w,\n/static/b0ad961dd38e43cd4fb0f2ce113a54e5/9d62a/flyway.png 908w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>프로젝트를 진행하다 보면, 데이터베이스가 위 그림처럼 <strong>여러 환경</strong>에서 존재하게 됩니다. 각자의 로컬 환경에 데이터베이스가 존재하고, 테스트 서버에도 프로덕션 서버에도 각각 별도의 데이터베이스가 존재합니다. 각자의 로컬 환경에서 개발을 하게 되면, 엔티티의 구조가 변경되고 이로 인해 데이터베이스의 <strong>스키마도 변경</strong>될 것 입니다.</p>\n<p>소프트웨어의 소스 코드와 같은 경우에는 Git과 같은 형상관리 툴을 사용하여 이런 문제를 비교적 잘 해결해왔습니다. 하지만, 데이터베이스는 그렇지 않았습니다.</p>\n<p>예를 들어 JPA를 사용하는 환경에서 엔티티 구조가 변경되면 이 변경된 구조를 다른 배포 환경의 데이터베이스에도 적용해야합니다. 즉, <strong>일일히 스키마 수정을 위한 DDL을 각 환경별로 모두 실행</strong>해줘야합니다.</p>\n<p>물론, 로컬 개발 환경이나 개발 서버에서는 Hibernate 설정 중 <code class=\"language-text\">ddl-auto</code> 을 <code class=\"language-text\">create</code> , <code class=\"language-text\">create-drop</code> , <code class=\"language-text\">update</code> 등으로 설정하여 DDL을 변경된 엔티티 구조에 맞춰 실행할 수 있지만, <strong>프로덕션에서는 이와 같은 설정이 불가능</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"members\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseEntity</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"email\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"display_name\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> displayName<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"profile_image_url\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> profileImageUrl<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Enumerated</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">EnumType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"social_type\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">SocialType</span> socialType<span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 코드는 달록의 <code class=\"language-text\">Member</code> 엔티티 코드입니다. 만약 달록이 이후에 서비스 가입 시 휴대전화 번호도 추가로 제공받게 된다면, 아래와 같은 필드가 엔티티에 추가될 것 입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"contact\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> contact<span class=\"token punctuation\">;</span></code></pre></div>\n<p>사실 로컬 개발 환경이나, 개발용 서버에서는 큰 문제가 없습니다. 테이블을 DROP 하고 엔티티 구조에 맞게 CREATE 하면 되니까요. 하지만, <strong>프로덕션 서버에서 테이블을 DROP 하는 것은 미친짓</strong>이죠. 실제 유저들의 데이터가 저장되어있기 때문입니다.</p>\n<p>그렇다면 프로덕션 서버에서는 어떻게 테이블 스키마가 변경된 것에 대응할 수 있을까요? <code class=\"language-text\">ALTER TABLE</code> 과 같이 테이블 스키마를 변경하는 <strong>DDL을 사용</strong>해야합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> members <span class=\"token keyword\">ADD</span> <span class=\"token keyword\">COLUMN</span> contact <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>엔티티 구조가 별로 변경되지 않았다면, 사람 손으로 위와 같은 DDL을 작성하고 프로덕션 서버에서 실행할 수는 있겠습니다. 하지만, 굉장히 번거로운 작업이며 <strong>사람의 실수(human error)</strong>가 발생하기 쉽습니다. 또한 <strong>형상관리도 어렵습니다.</strong></p>\n<p>포스팅에서 설명할 Flyway와 같은 데이터베이스 마이그레이션 툴을 사용하면, 위와 같은 문제를 해결할 수 있습니다. 이번 포스팅에서는 Flyway에 대한 기본적인 개념과 달록이 프로젝트에 적용한 과정에 대해 정리해봅니다.</p>\n<h2>실습 준비</h2>\n<h3>실습 환경</h3>\n<p>실습은 아래와 같은 환경에서 진행합니다. JPA를 사용하는 점 참고해주세요.</p>\n<ul>\n<li>SpringBoot</li>\n<li>Spring Data JPA (Hibernate)</li>\n<li>MySQL 8.0</li>\n</ul>\n<h3>JPA 엔티티</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> password<span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token comment\">// ...</span></code></pre></div>\n<p>위와 같은 JPA 엔티티가 존재한다고 가정합니다.</p>\n<h2>Flyway 실습 환경 구축</h2>\n<p>원래라면 Gradle에 스크립트를 작성하는 등 명령줄 인터페이스에서 Flyway를 사용해야 합니다 (<a href=\"https://flywaydb.org/documentation/getstarted/firststeps/gradle\">참고</a>). 하지만, <strong>Spring Boot는 기본적으로 Flyway와 Liquibase라는 고수준의 데이터베이스 마이그레이션 도구를 지원</strong>합니다. (<a href=\"https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/html/howto-database-initialization.html#howto-use-a-higher-level-database-migration-tool\">참고</a>) 따라서 Spring Boot 에서는 더 쉽게 Flyway를 프로젝트에 적용할 수 있습니다. 이번 포스팅에서는 Spring Boot에서 Flyway를 적용하는 방법에 대해서 다룹니다.</p>\n<h3>MySQL 컨테이너 띄우기</h3>\n<blockquote>\n<p>꼭 도커를 사용할 필요는 없습니다. 본 포스팅에서는 빠른 실습 환경 구축을 위해 도커를 사용합니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">mysql-db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span><span class=\"token number\">8.0</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./mysql<span class=\"token punctuation\">:</span>/var/lib/mysql\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 3306<span class=\"token punctuation\">:</span><span class=\"token number\">3306</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> root\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> flyway<span class=\"token punctuation\">-</span>study\n    <span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span> linux/x86_64</code></pre></div>\n<p><code class=\"language-text\">docker-compose.yml</code> 파일을 생성하고, 위 내용으로 채워줍니다. 아래 명령으로 MySQL 도커 컨테이너를 간단하게 띄울 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span></code></pre></div>\n<h3>의존성 추가</h3>\n<p><code class=\"language-text\">build.gradle</code> 의 <code class=\"language-text\">dependencies</code> 에 아래 내용을 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">implementation <span class=\"token string\">'org.flywaydb:flyway-core'</span></code></pre></div>\n<p>만약 여러분의 DBMS가 MySQL 8.X 버전이거나, MariaDB를 사용하신다면, 아래와 같이 종속성을 추가해야합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">implementation <span class=\"token string\">'org.flywaydb:flyway-mysql'</span></code></pre></div>\n<h3>DataSource 설정</h3>\n<p><code class=\"language-text\">application.yml</code> (혹은 <code class=\"language-text\">application.properties</code>) 에 DataSource 관련 설정을 추가 해야합니다. Spring Boot는 <strong>DataSource 설정으로 Flyway를 자동으로 연결</strong>하기 때문입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">driver-class-name</span><span class=\"token punctuation\">:</span> com.mysql.cj.jdbc.Driver\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> jdbc<span class=\"token punctuation\">:</span>mysql<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span>3306/flyway<span class=\"token punctuation\">-</span>study\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> root\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> root</code></pre></div>\n<h3>JPA 설정</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\"># ...</span>\n\t<span class=\"token key atrule\">jpa</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">hibernate</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ddl-auto</span><span class=\"token punctuation\">:</span> validate</code></pre></div>\n<p><code class=\"language-text\">ddl-auto</code> 옵션을 <code class=\"language-text\">validate</code> 로 설정하면, 실제 데이터베이스 스키마와 JPA 엔티티의 구조가 서로 같은지 비교하고, 같지 않다면 어플리케이션을 실행하지 못하도록 합니다. 이 옵션을 사용하여 Flyway를 사용했을 때 올바르게 데이터베이스 마이그레이션이 진행되었는지 확인해볼 것입니다.</p>\n<h3>Flyway 활성화</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\"># ...</span>\n\t<span class=\"token key atrule\">flyway</span><span class=\"token punctuation\">:</span>\n\t    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>위 설정을 추가하여 Spring Boot에서 Flyway를 활성화 합니다.</p>\n<h2>첫번째 마이그레이션 스크립트 작성</h2>\n<p>Flyway는 마이그레이션 스크립트의 버전 순서대로 SQL 스크립트를 실행합니다. 우리는 아직 아무런 마이그레이션 스크립트를 작성하지 않았습니다. 최초로 실행될 마이그레이션 스크립트를 아래와 같이 작성합니다. 파일 경로는 <code class=\"language-text\">resources/db/migration</code> 이며 파일명은 <code class=\"language-text\">V1__init.sql</code> 로 생성해주세요. 이때, <strong>언더스코어</strong>(<code class=\"language-text\">_</code>)<strong>가 2개임을 주의</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> member <span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">BIGINT</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n    name <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    email <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    password <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>마이그레이션의 버전과 명명법은 조금 있다가 다루겠습니다.</p>\n<h2>JPA 엔티티 구조 변경</h2>\n<p>시간이 흘러 애플리케이션이 기능 변경을 거듭하고, 회원가입 시 연락처 정보도 제공받게 되었습니다. JPA 엔티티 구조는 아래와 같이 변경되겠죠?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> password<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> contact<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가된 필드</span></code></pre></div>\n<p>그리고, 애플리케이션을 실행해봅니다. 예상하신것처럼 아래와 같이 JPA에서 에러가 발생하며 애플리케이션이 실행되지 않습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Schema-validation: missing column [contact] in table [member]</code></pre></div>\n<p><code class=\"language-text\">ddl-auto</code> 를 <code class=\"language-text\">validate</code> 로 설정했기 때문입니다. 실제 테이블에는 <code class=\"language-text\">contact</code> 라는 컬럼이 존재하지 않았는데, <code class=\"language-text\">Member</code> 엔티티에는 <code class=\"language-text\">contact</code> 필드가 추가되어 스키마가 불일치해서 발생하는 에러입니다.</p>\n<h2>새로운 버전의 마이그레이션 스크립트 작성</h2>\n<p>새로운 버전의 마이그레이션 스크립트를 생성하여, 현재 데이터베이스 테이블의 스키마를 엔티티와 일치하도록 만들어봅시다. <code class=\"language-text\">V2__add_contact.sql</code> 라는 이름으로 동일하게 <code class=\"language-text\">resources/db/migration</code> 디렉토리에 추가하고, 아래의 내용을 채워넣습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> member <span class=\"token keyword\">ADD</span> <span class=\"token keyword\">COLUMN</span> contact <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">ALTER TABLE</code> 은 이미 존재하는 테이블의 컬럼을 추가, 제거, 수정 등의 작업을 하기 위해 사용되는 DDL 입니다.</p>\n<h2>마이그레이션 스크립트 명명 규칙</h2>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/4b0a579982750eb5d4cc493d9ae07b32/4cd38/migration-naming-convention.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/klEQVQY0yWOSUvDUBRG+8sFobh256auLIhL7VZwKYJgbUVsEzuEvIwvaYa+jG2OL/FuLtzD990zimSEI3xcL6SuGrrTia7rSNMUP/BxbI80U/Rzbtph98x1BIEnsYWHlAe6tuWksyPDWLMT3yTxHhFabByXtmnIsiO/5gbTWhLJLb7cYwibsqz04wpzZ7HefRFHW4LIwhQCpRSjye0Nz8tLVvMxT/MJj9s9tJUuPDOd3DN7v+BnccXLxzV3xoqjKgbL2esnD29jjMV4YFMtVvSFySEhS3N8PyTPcsqioK5rVKGI41jfjoShJEmSgVXarudlUaJyRRBodvhnveEfBdMmNHoNJTcAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='migration naming convention' title='migration naming convention' src='/static/4b0a579982750eb5d4cc493d9ae07b32/ca1dc/migration-naming-convention.png' srcset='/static/4b0a579982750eb5d4cc493d9ae07b32/e7570/migration-naming-convention.png 170w,\n/static/4b0a579982750eb5d4cc493d9ae07b32/f46e7/migration-naming-convention.png 340w,\n/static/4b0a579982750eb5d4cc493d9ae07b32/ca1dc/migration-naming-convention.png 680w,\n/static/4b0a579982750eb5d4cc493d9ae07b32/02d09/migration-naming-convention.png 1020w,\n/static/4b0a579982750eb5d4cc493d9ae07b32/9d567/migration-naming-convention.png 1360w,\n/static/4b0a579982750eb5d4cc493d9ae07b32/4cd38/migration-naming-convention.png 3436w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>기본적으로 Flyway의 마이그레이션 스크립트의 파일 이름 명명법은 위를 따릅니다.** 숫자가 작은 버전의 마이그레이션부터 숫자가 큰 버전 순서대로 스크립트가 실행<strong>됩니다.</strong> 1부터 2, 3, 4, … 처럼 순차적으로 늘어나는 방식으로 사용해도 좋고, 20220101, 20220115, … 처럼 날짜 형태로 사용해도 좋습니다.**</p>\n<p>단, 버전은 정수로 인식되므로 <code class=\"language-text\">3.10</code> 과 <code class=\"language-text\">3.2</code> 중 <code class=\"language-text\">3.2</code> 가 먼저 실행됨을 주의하셔야합니다.</p>\n<h3>Versioned Migrations</h3>\n<p>Flyway의 핵심 기능입니다. 마이그레이션 스크립트의 최신 버전과 현재 데이터베이스의 스키마 버전을 비교하고,<strong>차이점이 있다면 마이그레이션 스크립트를 순차적으로 실행하여 최신 스키마와 격차를 좁혀</strong> 나갑니다.</p>\n<p>마이그레이션 버전이 1부터 9까지 있다고 가정해봅시다. 현재 개발환경의 데이터베이스 스키마가 5버전일 때, 최신 버전에 대해 마이그레이션을 실행하면, 마이그레이션 스크립트 6 ~ 9 버전이 순차적으로 실행됩니다. 개발 환경의 최신 스키마가 9버전이면, 아무 스크립트도 실행되지 않습니다.</p>\n<p>최신 마이그레이션 버전의 숫자보다 작은 숫자의 버전으로 마이그레이션 스크립트를 추가한다면, 그 마이그레이션 스크립트는 무시됩니다. 예를 들어 최신 버전이 <code class=\"language-text\">V10</code> 인데, <code class=\"language-text\">V9</code> 를 이후에 추가하는 경우입니다. 즉, 마이그레이션 스크립트를 추가할 때에는 <strong>항상 최신 마이그레이션 스크립트의 버전보다 큰 숫자로 버전을 설정</strong>해야합니다.</p>\n<h3>Undo Migrations</h3>\n<p>이 기능은 Flyway Teams 라는 유료 버전에서만 사용할 수 있습니다. Undo 기능은 때때로 위험할 수 있으므로 주의해서 사용해야한다고 합니다 (<a href=\"https://flywaydb.org/documentation/command/undo\">참고</a>).</p>\n<h3>Repeatable Migrations</h3>\n<p>모든 마이그레이션 스크립트가 실행된 이후 실행되는 스크립트 입니다. Repeatable Migrations 끼리는 description 순서대로 실행됩니다. <strong>한번 실행되며, 파일이 변경되어 체크섬이 변경되면 또 실행</strong>됩니다.</p>\n<h2>flyway_schema_history</h2>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f7665ec45d8300f9a81eeadd718c179a/de83e/flyway_schema_history.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 12.352941176470589%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAXklEQVQI1z2MWwpAIRBCW0xF0fSiKGj/+/KiH/dDFMc5rveOOSfGGPJzzp9rrfDeI+eMtRZaaxJ/9t7qSynasTczuJQSKI7ohHFAJ4Rgjt97yiEE3e69gvInxigw8wdNLT1sqw0TxgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='flyway schema history' title='flyway schema history' src='/static/f7665ec45d8300f9a81eeadd718c179a/ca1dc/flyway_schema_history.png' srcset='/static/f7665ec45d8300f9a81eeadd718c179a/e7570/flyway_schema_history.png 170w,\n/static/f7665ec45d8300f9a81eeadd718c179a/f46e7/flyway_schema_history.png 340w,\n/static/f7665ec45d8300f9a81eeadd718c179a/ca1dc/flyway_schema_history.png 680w,\n/static/f7665ec45d8300f9a81eeadd718c179a/02d09/flyway_schema_history.png 1020w,\n/static/f7665ec45d8300f9a81eeadd718c179a/9d567/flyway_schema_history.png 1360w,\n/static/f7665ec45d8300f9a81eeadd718c179a/de83e/flyway_schema_history.png 2414w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>데이터베이스를 확인해보면, 우리가 생성하지 않은 테이블이 하나 생성된 것을 확인할 수 있습니다. <code class=\"language-text\">flyway_schema_history</code> 라는 이름의 테이블인데요, Flyway는 이 테이블을 사용하여, 마이그레이션에 대한 버전 관리를 합니다. 한번 <code class=\"language-text\">V2__add_contact.sql</code> 을 제거하고, <code class=\"language-text\">V1__init.sql</code> 에 <code class=\"language-text\">contact</code> 컬럼을 추가해볼까요? <code class=\"language-text\">V1__init.sql</code> 을 아래와 같이 변경하고, 애플리케이션을 실행해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> member <span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">BIGINT</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n    name <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    email <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    password <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    contact <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>애플리케이션이 잘 실행되나요? Flyway에서 아래와 같은 에러가 발생할 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Caused by: org.flywaydb.core.api.exception.FlywayValidateException: Validate failed: Migrations have failed validation\nMigration checksum mismatch for migration version 1\n-> Applied to database : -714805521\n-> Resolved locally    : 1143495658\nEither revert the changes to the migration, or run repair to update the schema history.</code></pre></div>\n<p>Flyway는 각 마이그레이션 스크립트 별로 체크섬을 비교하여 유효성을 검사합니다. 따라서, 스키마에 대한 모든 변경은 반드시 새로운 버전의 마이그레이션 스크립트를 추가하는 방법으로 진행해야합니다.</p>\n<h2>주의점</h2>\n<p>Spring Boot는 기본적으로 <code class=\"language-text\">schema.sql</code> 과 <code class=\"language-text\">data.sql</code> 을 통해 데이터베이스 스키마를 초기화하고, 데이터를 추가할 수 있는 기능을 제공합니다. 하지만, 이 기능은 당연하지만 Flyway와 함께 사용해서는 안됩니다 (<a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization.using-basic-sql-scripts\">참고</a>).</p>\n<p>또한, 엔티티의 구조가 변경되었을때 반드시 마이그레이션 스크립트를 작성해야합니다. 일반적으로 프로덕션에서는 <code class=\"language-text\">ddl-auto</code> 를 <code class=\"language-text\">validate</code> 로 설정합니다.</p>\n<h2>참고</h2>\n<ul>\n<li><a href=\"https://www.code4copy.com/java/spring-boot-flyway-db-migration-integration-example/\">https://www.code4copy.com/java/spring-boot-flyway-db-migration-integration-example/</a></li>\n<li><a href=\"https://www.techgeeknext.com/spring-boot/spring-boot-flyway-example\">https://www.techgeeknext.com/spring-boot/spring-boot-flyway-example</a></li>\n<li><a href=\"https://blog.gangnamunni.com/post/introducing-flyway/\">https://blog.gangnamunni.com/post/introducing-flyway/</a></li>\n<li><a href=\"https://flywaydb.org/documentation/\">https://flywaydb.org/documentation/</a></li>\n</ul>","frontmatter":{"title":"달록의 데이터베이스 마이그레이션을 위한 Flyway 적용기","date":"September 08, 2022","update":null,"tags":["DevOps"],"series":null},"fields":{"slug":"/dallog-flyway/","readingTime":{"minutes":16.07}}},"seriesList":{"edges":[{"node":{"id":"a621dc7b-8590-5ec6-9b52-3d9e5182486d","fields":{"slug":"/appearance-background-of-jpa/"},"frontmatter":{"title":"JPA 등장배경"}}},{"node":{"id":"9d2a87b6-2b9c-5b87-b790-3426d17c2d8e","fields":{"slug":"/intellij-final-keyword/"},"frontmatter":{"title":"IntelliJ에서 메소드 추출한 메소드의 파라미터에 final 키워드 자동 추가하기"}}},{"node":{"id":"251e9767-1c92-5cf5-9cef-2c4a42c10df2","fields":{"slug":"/git-branch-strategy/"},"frontmatter":{"title":"달록팀의 git 브랜치 전략을 소개합니다."}}},{"node":{"id":"5090cce3-0c1f-5376-badc-1d25e44c1bd9","fields":{"slug":"/infinite-scroll/"},"frontmatter":{"title":"React에서 무한 스크롤 구현하기"}}},{"node":{"id":"bcb53ba5-0286-5d10-96c2-fdcb88e2cc60","fields":{"slug":"/package-structure/"},"frontmatter":{"title":"달록에 적절한 패키지 구조 고민하기"}}},{"node":{"id":"a7fc89de-f37c-596e-a81d-3d4fe5a795b8","fields":{"slug":"/data-jpa-slice-page/"},"frontmatter":{"title":"Spring Data JPA의 Slice & Page"}}},{"node":{"id":"e1ba92ee-0cf0-50c8-80bd-5da5075df8d1","fields":{"slug":"/data-jpa-auditing/"},"frontmatter":{"title":"Spring Data JPA의 Auditing"}}},{"node":{"id":"3e036508-c916-504e-9e8d-89f69332471e","fields":{"slug":"/separated-interface/"},"frontmatter":{"title":"외부와 의존성 분리하기"}}},{"node":{"id":"cade544a-16ef-58a3-b97c-824986a8395f","fields":{"slug":"/apply-rest-docs/"},"frontmatter":{"title":"MockMvc를 사용한 Spring RestDocs"}}},{"node":{"id":"87649d54-d59e-58a6-afd5-8491eb4113a8","fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}}},{"node":{"id":"eb380f6d-5a00-5a9e-a916-003fb292cc8a","fields":{"slug":"/test-fixture-constant/"},"frontmatter":{"title":"테스트에서 Entity 객체를 상수로 두면 안 되는 이유"}}},{"node":{"id":"9734e30a-b430-5922-919d-f53808a56eb9","fields":{"slug":"/what_is_nginx/"},"frontmatter":{"title":"NGINX 란?"}}},{"node":{"id":"9ebc6e21-2a76-5d42-be33-c2dae8c849b2","fields":{"slug":"/ssl_protocol/"},"frontmatter":{"title":"SSL을 통한 HTTPS통신 과정"}}},{"node":{"id":"fa5ad595-1f81-5a20-a884-2da69adee3c5","fields":{"slug":"/integration-test-slice-test/"},"frontmatter":{"title":"통합 테스트와 슬라이스 테스트"}}},{"node":{"id":"d8c66823-bb05-5e83-a6a1-2fd9af450b6f","fields":{"slug":"/query-invalidation/"},"frontmatter":{"title":"React-Query에서의 데이터 최신화 (Query Invalidation)"}}},{"node":{"id":"f5187517-342f-52a1-9092-d12c1a80d132","fields":{"slug":"/seperate-components/"},"frontmatter":{"title":"컴포넌트 분리 기준"}}},{"node":{"id":"d6249c8b-bea6-5c91-8477-d3dd15ad9b39","fields":{"slug":"/test-isolation/"},"frontmatter":{"title":"테스트 격리"}}},{"node":{"id":"98e390ef-fb19-5d01-a3ef-d14bc0e65176","fields":{"slug":"/dallog-jacoco/"},"frontmatter":{"title":"달록의 Jacoco 적용기 (feat. Gradle)"}}},{"node":{"id":"33d19946-de0c-5b41-bfa0-d7c3fd80f10b","fields":{"slug":"/google-refresh-token/"},"frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다."}}},{"node":{"id":"8168857d-a82c-5608-bd40-cea4b917d17d","fields":{"slug":"/submodule/"},"frontmatter":{"title":"달록 서브모듈 도입기"}}},{"node":{"id":"836fc724-7e2f-5c7a-a42b-c0cc9163167a","fields":{"slug":"/dallog-flyway/"},"frontmatter":{"title":"달록의 데이터베이스 마이그레이션을 위한 Flyway 적용기"}}},{"node":{"id":"7a3bde6d-746b-56fd-8d91-0d8059ebf1f8","fields":{"slug":"/json-property-json-naming/"},"frontmatter":{"title":"@JsonProperty, @JsonNaming"}}},{"node":{"id":"50673f5c-f835-5982-b70c-b77e5a352a2c","fields":{"slug":"/servlet-life-cycle/"},"frontmatter":{"title":"서블릿 생명주기와 직접만든 톰캣을 통한 의문점"}}},{"node":{"id":"61e7f4d1-7b3a-5968-bfe8-c3f6efb88748","fields":{"slug":"/preparing-for-performance-test/"},"frontmatter":{"title":"톰캣 튜닝을 위한 달록의 서버 성능 테스트 준비 과정"}}},{"node":{"id":"9272061d-68c6-5f82-a961-0e2efe0fd6be","fields":{"slug":"/cyclic-dependency/"},"frontmatter":{"title":"cyclic dependency"}}},{"node":{"id":"6e779308-f266-58af-bfcc-e9fee6d39a98","fields":{"slug":"/multi-datasource-issue-with-osiv/"},"frontmatter":{"title":"대체 왜 DataSource 라우팅이 안되는거야!? (feat. OSIV)"}}},{"node":{"id":"0e63245e-c52c-5977-9f60-f94ee0fd00fc","fields":{"slug":"/hikari-cp-theory/"},"frontmatter":{"title":"HikariCP와 적절한 풀 사이즈 고민하기 (이론편)"}}},{"node":{"id":"c7bea043-345c-5f78-ae53-796a83812961","fields":{"slug":"/react-query-useMutation-trouble-shooting/"},"frontmatter":{"title":"react-query useMutation onSuccess 안 되는줄 알았던 트러블 슈팅"}}}]},"previous":{"fields":{"slug":"/submodule/"},"frontmatter":{"title":"달록 서브모듈 도입기"}},"next":{"fields":{"slug":"/json-property-json-naming/"},"frontmatter":{"title":"@JsonProperty, @JsonNaming"}}},"pageContext":{"id":"836fc724-7e2f-5c7a-a42b-c0cc9163167a","series":null,"previousPostId":"8168857d-a82c-5608-bd40-cea4b917d17d","nextPostId":"7a3bde6d-746b-56fd-8d91-0d8059ebf1f8"}},"staticQueryHashes":[]}