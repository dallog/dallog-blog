{"componentChunkName":"component---src-templates-post-jsx","path":"/google-refresh-token/","result":{"data":{"site":{"siteMetadata":{"title":"dal.log"}},"markdownRemark":{"id":"33d19946-de0c-5b41-bfa0-d7c3fd80f10b","excerpt":"이 글은 우테코 달록팀 크루 매트가 작성했습니다. Google은 Refresh Token을 쉽게 내주지 않는다. 우리 달록은 캘린더를 손쉽게 공유할 수 이다. 현재에는 우리 서비스 내에서만 일정이 등록 가능한 상태이다. 추후 확장성을 고려하여 와 연동하기 위해 Google에서 제공하는 token 정보를 관리해야 하는 요구사항이 추가 되었다. code를 활…","html":"<blockquote>\n<p>이 글은 우테코 달록팀 크루 <a href=\"https://github.com/hyeonic\">매트</a>가 작성했습니다.</p>\n</blockquote>\n<h2>Google은 Refresh Token을 쉽게 내주지 않는다.</h2>\n<p>우리 <a href=\"https://github.com/woowacourse-teams/2022-dallog\">달록</a>은 캘린더를 손쉽게 공유할 수 <code class=\"language-text\">구독형 캘린더 공유 서비스</code>이다. 현재에는 우리 서비스 내에서만 일정이 등록 가능한 상태이다. 추후 확장성을 고려하여 <code class=\"language-text\">Google Calendar API</code>와 연동하기 위해 Google에서 제공하는 token 정보를 관리해야 하는 요구사항이 추가 되었다.</p>\n<h2>code를 활용한 AccessToken 및 IdToken 발급</h2>\n<p>Google은 OAuth 2.0 요청 때 적절한 <code class=\"language-text\">scope(e.g. openid)</code>를 추가하면 <code class=\"language-text\">OpenID Connect</code>를 통해 Google 리소스에 접근 가능한 <code class=\"language-text\">Access Token</code>, AccessToken을 재발급 받기 위한 <code class=\"language-text\">Refresh Token</code>, 회원의 정보가 담긴 <code class=\"language-text\">IdToken</code>을 발급해준다. </p>\n<p><code class=\"language-text\">Access Token</code>의 경우 짧은 만료 시간을 가지고 있기 때문에 google <code class=\"language-text\">Access Token</code> 재발급을 위한 <code class=\"language-text\">Refresh Token</code>을 저장하고 관리해야 한다. <code class=\"language-text\">Refresh Token</code>은 <code class=\"language-text\">Access Token</code>보다 긴 만료 시간을 가지고 있기 때문에 보안에 유의해야 한다. 그렇기 때문에 프론트 측에서 관리하는 것 보다 달록 DB에 저장한 뒤 관리하기로 결정 하였다. 참고로 Google은 보통 아래와 같은 이유가 발생할 때 <code class=\"language-text\">Refresh Token</code>을 만료시킨다고 한다.</p>\n<p><a href=\"https://developers.google.com/identity/protocols/oauth2#expiration\">Refresh Token 만료</a></p>\n<ul>\n<li>사용자가 앱의 액세스 권한을 취소한 경우</li>\n<li>Refresh Token이 6개월 동안 사용되지 않은 경우</li>\n<li>사용자가 비밀번호를 변경했으며 Gmail scope가 포함된 경우</li>\n<li>사용자가 계정에 부여된 Refresh Token 한도를 초과한 경우</li>\n<li>세션 제어 정책이 적용되는 Google Cloud Platform 조직에 사용자가 속해있는 경우</li>\n</ul>\n<p>정리하면 <code class=\"language-text\">Refresh Token</code>은 만료 기간이 비교적 길기 때문에 서버 측에서 안전하게 보관하며 필요할 때 리소스 접근을 위한 <code class=\"language-text\">Access Token</code>을 발급 받는 형태를 구상하게 되었다.</p>\n<p>우리 <a href=\"https://github.com/woowacourse-teams/2022-dallog\">달록</a>은 아래와 같은 형태로 인증이 이루어진다. </p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/4c02b6ded86cbf0190013659f8371f6c/c7a69/oauth-flow.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQoz22S646CMBCFef+3MuGvBONGA5QFNdDFIKCrXIWznGZLgDhJM3Q6fHM1jscjTNPEZrOBZVk4nU7I8xyUvu/xer1AH9d11be2U4ZhmLS2GY/HA4fDAUmSYC7n8xlBECCWMayvPbbbLS6Xi9KEz2G+72O32+F+v8No2xbX6xVZlilDHMdgEN6ZKW3MmnDepZR4Pp8TkMJ7mqYgy9BRWA4feG63mwKEYYgoilCWpXqv6xrv93sCzaFaFLBpGvVT13XKiUD2ja0QnkD1/1ZV1SI7rdk/ZjcBGZUQ9sZxHNi2rfrFEgUzlRFc4cHzPAX9BGTABZAlsTz2iANS5Y1OSZ5BpD/Yew7CIEQ9VrMGUi+A+jIXDkYIgW4M1qBH2TbKj6XN10avzKJkOtKoHPrRYdTyt8B3IlEUxSKQ7vOngUxADfs0vQHDBNDZ6HduAneQlVBzDsYaNO/LOpN17zg07isPYdyAP6NNT/9Z3XF+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='oauth flow' title='oauth flow' src='/static/4c02b6ded86cbf0190013659f8371f6c/ca1dc/oauth-flow.png' srcset='/static/4c02b6ded86cbf0190013659f8371f6c/e7570/oauth-flow.png 170w,\n/static/4c02b6ded86cbf0190013659f8371f6c/f46e7/oauth-flow.png 340w,\n/static/4c02b6ded86cbf0190013659f8371f6c/ca1dc/oauth-flow.png 680w,\n/static/4c02b6ded86cbf0190013659f8371f6c/02d09/oauth-flow.png 1020w,\n/static/4c02b6ded86cbf0190013659f8371f6c/9d567/oauth-flow.png 1360w,\n/static/4c02b6ded86cbf0190013659f8371f6c/c7a69/oauth-flow.png 2560w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p><em>달록팀 후디 고마워요!</em></p>\n</blockquote>\n<p>프론트 측에서 <code class=\"language-text\">OAuth 인증</code>을 위해서는 달록 서버에서 제공하는 <code class=\"language-text\">OAuth 인증을 위한 페이지 uri</code>을 활용해야 한다. 달록 서버는 해당 uri를 생성하여 전달한다. 로직은 아래 코드로 구현되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthUri</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthUri</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthUri</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getOAuthEndPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"?\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"client_id=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"redirect_uri=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"response_type=code&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"scope=\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getScopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 브라우저에서 해당 uri에 접속하면 아래와 같은 페이지를 확인할 수 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7b4590a4b46a14708d45e7589d075bf7/b2dbf/google-oauth-uri.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 111.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4klEQVQ4y61U226bQBD1/yu/0cf8QtRKfYn8YMmV2sqxkwBezB1jYzCwcDKz1K6hCyVRRhp2WHYPczkzs7qWKLMM+blAluVI0xOOx5TsTL1LKdE0Deq6nqQzKUvskwjxPoHjuPA8H47rIowiRFGMsiwnA/LPZ5KMBiztsy+Xg5MB2SAXrpDsza2+R1TI/OiD3IItl0vM53OsVissFgt1CQM/7gDqDlV0N4wT2I4H3w/gUm7T06lz9mJ3AXlT0trz9smp8EM02LglDNOCZW1hGMY/QIMe3kq7d6u679CHzBJ/XSL5bUL4LoIg0AIMFaoLKFtA4+4e/sMCIvJhUXi7nQPX8xCGIfI81+Z4uCiXspPm1CFFUeB8PpMWZJctD0fJrfEw//IN6eMvrIUFsRUEUqsuqapK6RgntR6W33+iWNsIjwcERBFuPQ7bp3zG+73yYnLILAWDEvSJeMaDIU1TFfrfLmgGtO4Cyj8huzQY4jiGELbi28urQQWJrgfHvBvtFF1//k9Hif2RwaDNIc9BwzSxeX6hnvXwSiELuw2flTlp0sopWW+esXMcVbitEEiSRGFw+q6ADMJ544tboo1t7+iwrYCVTXv8zqtJxE8Oh+vgndTL/RR8yjzs53as/TqAn6lvZjy7C+YOEiIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google oauth uri' title='google oauth uri' src='/static/7b4590a4b46a14708d45e7589d075bf7/ca1dc/google-oauth-uri.png' srcset='/static/7b4590a4b46a14708d45e7589d075bf7/e7570/google-oauth-uri.png 170w,\n/static/7b4590a4b46a14708d45e7589d075bf7/f46e7/google-oauth-uri.png 340w,\n/static/7b4590a4b46a14708d45e7589d075bf7/ca1dc/google-oauth-uri.png 680w,\n/static/7b4590a4b46a14708d45e7589d075bf7/b2dbf/google-oauth-uri.png 946w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>계정을 선택하면 <code class=\"language-text\">redirect uri</code>와 함께 <code class=\"language-text\">code</code> 값이 전달되고, google의 token을 발급 받기 위해 백엔드 서버로 <code class=\"language-text\">code</code> 정보를 전달하게 된다. 아래는 실제 code 정보를 기반으로 google token을 생성한 뒤 <code class=\"language-text\">id token</code>에 명시된 정보를 기반으로 회원을 생성 or 조회한 뒤 <code class=\"language-text\">달록 리소스에 접근하기 위한 access token</code>을 발급해주는 API이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/auth\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthController</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>authService <span class=\"token operator\">=</span> authService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/{oauthProvider}/token\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TokenResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">generateToken</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> oauthProvider<span class=\"token punctuation\">,</span>\n                                                       <span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">TokenRequest</span> tokenRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">TokenResponse</span> tokenResponse <span class=\"token operator\">=</span> authService<span class=\"token punctuation\">.</span><span class=\"token function\">generateToken</span><span class=\"token punctuation\">(</span>tokenRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>tokenResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">authService.generateToken(tokenRequest.getCode())</code>: code 정보를 기반으로 google 토큰 정보를 조회한다. 메서드 내부에서 <a href=\"https://developers.google.com/identity/protocols/oauth2/openid-connect#exchangecode\">code을 액세스 토큰 및 ID 토큰으로 교환</a>에서 제공된 형식에 맞춰 google에게 code 정보를 전달하고 토큰 정보를 교환한다. </li>\n</ul>\n<p>실제 Google에서 토큰 정보를 교환 받는 클라이언트를 담당하는 <code class=\"language-text\">GoogleOAuthClient</code>이다. 핵심은 인가 코드를 기반으로 <code class=\"language-text\">GoogleTokenResponse</code>를 발급 받는 다는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthClient</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthClient</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">JWT_DELIMITER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\\\\.\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> objectMapper<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder<span class=\"token punctuation\">,</span>\n                             <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> objectMapper<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>objectMapper <span class=\"token operator\">=</span> objectMapper<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuthMember</span> <span class=\"token function\">getOAuthMember</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// code을 액세스 토큰 및 ID 토큰으로 교환</span>\n        <span class=\"token class-name\">GoogleTokenResponse</span> googleTokenResponse <span class=\"token operator\">=</span> <span class=\"token function\">requestGoogleToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> payload <span class=\"token operator\">=</span> <span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span>googleTokenResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getIdToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">UserInfo</span> userInfo <span class=\"token operator\">=</span> <span class=\"token function\">parseUserInfo</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">String</span> refreshToken <span class=\"token operator\">=</span> googleTokenResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getRefreshToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthMember</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getPicture</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">GoogleTokenResponse</span> <span class=\"token function\">requestGoogleToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> params <span class=\"token operator\">=</span> <span class=\"token function\">generateTokenParams</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MultiValueMap</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">fetchGoogleToken</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">generateTokenParams</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> params <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedMultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_secret\"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientSecret</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"authorization_code\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> params<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">GoogleTokenResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">fetchGoogleToken</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">final</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MultiValueMap</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getTokenUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">GoogleTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RestClientException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> jwt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JWT_DELIMITER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">parseUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> payload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> decodedPayload <span class=\"token operator\">=</span> <span class=\"token function\">decodeJwtPayload</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> objectMapper<span class=\"token punctuation\">.</span><span class=\"token function\">readValue</span><span class=\"token punctuation\">(</span>decodedPayload<span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JsonProcessingException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id 토큰을 읽을 수 없습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">decodeJwtPayload</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> payload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUrlDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 Google에게 제공 받은 <code class=\"language-text\">Refresh Token</code>을 저장해보자.</p>\n<h2>Refresh Token에 채워진 null</h2>\n<p>이게 무슨 일인가, 분명 요청 형식에 맞춰 헤더를 채워 디버깅을 해보면 계속해서 <code class=\"language-text\">null</code> 값으로 전달되고 있는 것이다. 즉, Google 측에서 Refresh Token을 보내주지 않고 있다는 것을 의미한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/40821173b75b8bc6f832d00faa388a42/7c559/google-refresh-token-null.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAiklEQVQI11VOWwrDMAzrwZom8SOxmz7G2NjPPsbuf4jZpYEOhJAtIXv4rPt32Z/zUrRSE5oFVVBqaRqZAkIgcL6CYCIYAYZHW+9VSCWKRfPEENg9TzDGgpHBeCqHNsGdGYdXW7eiUdHLsiPkU4w5d1w2qY92+b3tN9XUKFWvt8sn6MLs+0B/lv3/A4PePxg8B29TAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token null' title='google refresh token null' src='/static/40821173b75b8bc6f832d00faa388a42/ca1dc/google-refresh-token-null.png' srcset='/static/40821173b75b8bc6f832d00faa388a42/e7570/google-refresh-token-null.png 170w,\n/static/40821173b75b8bc6f832d00faa388a42/f46e7/google-refresh-token-null.png 340w,\n/static/40821173b75b8bc6f832d00faa388a42/ca1dc/google-refresh-token-null.png 680w,\n/static/40821173b75b8bc6f832d00faa388a42/02d09/google-refresh-token-null.png 1020w,\n/static/40821173b75b8bc6f832d00faa388a42/9d567/google-refresh-token-null.png 1360w,\n/static/40821173b75b8bc6f832d00faa388a42/7c559/google-refresh-token-null.png 1540w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>다시 한번 <a href=\"https://developers.google.com/identity/protocols/oauth2/web-server#offline\">액세스 토큰 새로고침 (오프라인 액세스)</a>를 살펴보았다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fd2dd90efd7002666575df63734befc8/dff2b/google-refresh-token-docs.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 61.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8klEQVQoz41T29qaQAz0/V+v1VZQzgoLLLCAgNi/00xWe9WL+n1jDizZTDIcrLVI0hR1XSPPC6Rphvv9jtvthizLxS/VOufwP7/DsqyY51kxTRMmscPgMEgBtYK+72Fth3EcFSxOO03+HX9u0BqHqqrw/XhEeLngfA4QhCFOpxOSJNUu4zhBlueI4lhtURSCd/dlqXEu+VieW9visO87mqaBbRtUVYm2bQUWy7Lg+Xxi2za1r9cv8Z9Y11Vzj8cDDznDWHNy5uu3UCbvYVqRVQ632r3n9plh5iEzJoyphKoTygP6rhOaPZxQZTy4Cev+5Qv2w4iqtmg7h8oYDxkFOydMN6PqNrTjC+MKzE9g2YFxE4jfuQX7/vRL4V9tBxwvN5yvic6CczwHAcLwIr7M9priZxjj2ynEJc4VUZwhSnL8CK565io5N+++oJtXpGWPrCiRC8U4SZRyWXrJpGmi+UKGvyyPv9hWKmR6x4vMWQpy/U1To62NLoTyoCbpfyiTPvVqTK2W4IaNMbrAzzMu61CWFYIgRC7rp0SiKH53lXm5RJEIP8NV8hyBv9R6ZXS8vNFcLTG3rR1yq6RHmryVL1Bfn06NWIKxc6OKmbKhwOmTLq12SIWnIgl+dlzI51OjXJjzn6OIXMTMiyl4MqH/r4J/AJuUheYYjXkhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token docs' title='google refresh token docs' src='/static/fd2dd90efd7002666575df63734befc8/ca1dc/google-refresh-token-docs.png' srcset='/static/fd2dd90efd7002666575df63734befc8/e7570/google-refresh-token-docs.png 170w,\n/static/fd2dd90efd7002666575df63734befc8/f46e7/google-refresh-token-docs.png 340w,\n/static/fd2dd90efd7002666575df63734befc8/ca1dc/google-refresh-token-docs.png 680w,\n/static/fd2dd90efd7002666575df63734befc8/dff2b/google-refresh-token-docs.png 767w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>정리하면 <a href=\"https://developers.google.com/identity/protocols/oauth2/web-server#redirecting\">Google OAuth 2.0 서버로 리디렉션</a>할 때 query parameter에 <code class=\"language-text\">access_type</code>을 <code class=\"language-text\">offline</code>으로 설정해야 한다는 것이다. 다시 되돌아 가서 Google 인증 요청을 위한 uri를 생성하는 메서드를 아래와 같이 수정하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthUri</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthUri</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthUri</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getOAuthEndPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"?\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"client_id=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"redirect_uri=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"response_type=code&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"scope=\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getScopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"access_type=offline\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가된 부분</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 다시 요청을 진행해보자! 분명 <code class=\"language-text\">refresh token</code>이 정상적으로 교환될 것이다.</p>\n<h2>또 다시 Refresh Token에 채워진 null</h2>\n<p>분명 문서에 명시한 대로 설정을 진행했지만 아직도 동일하게 <code class=\"language-text\">null</code> 값이 채워져 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f0a948c22b5527c308e2c44e13f5f8d7/5b400/google-refresh-token-null-2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 38.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABYlAAAWJQFJUiTwAAABIElEQVQY01WP627CMAyF+1xAL7nYjuOkLbBx2wRMY2jb+z/AHFp+TDr6dI4V23H1SuEU07vkPYuaA8sxyJbEYEAWCIKcPEUIUenmYgySjadqvH1exs055o803PJ4kByZOKFLCJlwCGqUPiP2ShU5QZ/IClTwfd/k4Y1Fl18l98hOEiRZdmZpjHKltA8+4lSZVNH966UfLjHvOAkxBIDEqgZsg1bZomvBNeBatC3NxRLJleZp8z6mxkPL1ibflEeufarD8rR9cp4YSvP9MKz15qv0Q5CWQJtraxeNWdTdop7Y/fezqfj3Zzeu9dqj5K2ICajNNkHt7cqa2imtzlKjnP1TlT+fR8knFkJegjXRl7+RM+I7LtKKeh1XYnAlqrjoD3uKhTQS4OGGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token null 2' title='google refresh token null 2' src='/static/f0a948c22b5527c308e2c44e13f5f8d7/ca1dc/google-refresh-token-null-2.png' srcset='/static/f0a948c22b5527c308e2c44e13f5f8d7/e7570/google-refresh-token-null-2.png 170w,\n/static/f0a948c22b5527c308e2c44e13f5f8d7/f46e7/google-refresh-token-null-2.png 340w,\n/static/f0a948c22b5527c308e2c44e13f5f8d7/ca1dc/google-refresh-token-null-2.png 680w,\n/static/f0a948c22b5527c308e2c44e13f5f8d7/5b400/google-refresh-token-null-2.png 770w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p><em>해달라는 데로 다해줬는데...</em></p>\n</blockquote>\n<h2>엄격한 Google</h2>\n<p>Google은 OAuth 2.0을 통해 인증을 받을 때 Refresh Token을 굉장히 엄격하게 다룬다. 사용자가 로그인을 진행할 때 마다 Refresh Token 정보를 주는 것이 아니라, Google에 등록된 App에 최초 로그인 할 때만 제공해준다. 즉, 재로그인을 진행해도 Refresh Token은 발급해주지 않는다. </p>\n<p>Google의 의도대로 동작하려면 내가 우리 서비스에 최초로 로그인을 진행하는 시점에만 Refresh Token을 발급받고 서버 내부에 저장한 뒤 필요할 때 꺼내 사용해야 한다.</p>\n<p>하지만 우리 서버는 모종의 이유로 최초에 받아온 Refresh Token을 저장하지 못할 수 있다. 이때 <a href=\"https://developers.google.com/identity/protocols/oauth2/web-server#redirecting\">Google OAuth 2.0 서버로 리디렉션</a>할 때 <code class=\"language-text\">prompt</code>를 <code class=\"language-text\">consent</code>로 설정하게 되면 매 로그인 마다 사용자에게 동의를 요청하기 때문에 강제로 <code class=\"language-text\">Refresh Token</code>을 받도록 지정할 수 있다.</p>\n<p>이제 진짜 마지막이다. 아래와 같이 수정한 뒤 다시 디버깅을 진행하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthUri</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthUri</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthUri</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getOAuthEndPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"?\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"client_id=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"redirect_uri=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"response_type=code&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"scope=\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getScopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"access_type=offline\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"prompt=consent\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가된 부분</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/ac7268ed5711abec2e8ce73110f7c556/e4da8/google-refresh-token-success.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9ElEQVQY03VP7W7DIBDLeyVrOD6PO0hItymdlKZrk73/KwxINe3HJlmWOfDZNGjtZUj3OC4UbzxkXjheOSZiid56Rg6ZLbEjPsTPsRHK4Nc+p2nxvIbhMwzkfI9aBg2+sAwGSMlospCsn8i3rBtQxmyPeZxWCjlz5UiOTq7aqPpZC6+h6mw4ICs30lizb5d0vlN89QGcFV6VF5Q9SpAqtt/wZZfAPDeN0NZuj/dxWpBnz8aiIK2ieZGy66ED6MTfaAU0oEvyRzpffbhxHJB6V6s61fbQnqDwP6jJ+/Y2pmwOSNKbo97RTRw9UfVOCawfwafIk28VW3VhwS0y3wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token success' title='google refresh token success' src='/static/ac7268ed5711abec2e8ce73110f7c556/ca1dc/google-refresh-token-success.png' srcset='/static/ac7268ed5711abec2e8ce73110f7c556/e7570/google-refresh-token-success.png 170w,\n/static/ac7268ed5711abec2e8ce73110f7c556/f46e7/google-refresh-token-success.png 340w,\n/static/ac7268ed5711abec2e8ce73110f7c556/ca1dc/google-refresh-token-success.png 680w,\n/static/ac7268ed5711abec2e8ce73110f7c556/e4da8/google-refresh-token-success.png 766w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>정상적으로 발급 되는 것을 확인할 수 있다!</p>\n<h2>문제점</h2>\n<p>하지만 여기서 문제가 하나 있다. 단순히 <code class=\"language-text\">prompt</code>를 <code class=\"language-text\">consent</code>로 설정할 경우 우리 서비스에 가입된 사용자는 Google OAuth 2.0 인증을 진행할 때 매번 재로그인을 진행해야 한다. 이것은 사용자에게 매우 <code class=\"language-text\">불쾌한 경험</code>으로 다가올 수 있다. 즉 우리는 매번 <code class=\"language-text\">재로그인</code>을 통해 Refresh Token을 발급 받는 것이 아닌, 최초 로그인 시 <code class=\"language-text\">Refresh Token</code>을 발급 받은 뒤 적절한 저장소에 저장하고 관리해야 한다.</p>\n<p>그렇다면 실제 운영 환경이 아닌 테스트 환경에서는 어떻게 해야 할까? 운영 환경과 동일한 <code class=\"language-text\">Google Cloud Project</code>를 사용할 경우 최초 로그인을 진행할 때 <code class=\"language-text\">내 권한 정보가 등록</code>된다. 즉 Refresh Token을 재발급 받을 수 없다는 것을 의미한다. </p>\n<p>우리 달록은 운영 환경과 테스트 환경에서 서로 다른 <code class=\"language-text\">Google Cloud Project</code>를 생성하여 관리하는 방향에 대해 고민하고 있다. 이미 Spring Profile 기능을 통해 각 실행 환경에 대한 설정을 분리해두었기 때문에 쉽게 적용이 가능할 것이라 기대한다. 정리하면 아래와 같다.</p>\n<ul>\n<li><code class=\"language-text\">운영 환경</code>: Refresh Token 발급을 위해 <code class=\"language-text\">accept_type</code>을 <code class=\"language-text\">offline</code>으로 설정한다. 단 최초 로그인에만 Refresh Token을 발급 받기 위해 <code class=\"language-text\">prompt</code>는 명시하지 않는다.</li>\n<li><code class=\"language-text\">개발 환경</code>: 개발 환경에서는 매번 DataBase가 초기화 되기 때문에 Refresh Token을 유지하여 관리할 수 없다. 테스트를 위한 추가적인 <code class=\"language-text\">Google Cloud Project</code>를 생성한 뒤, <code class=\"language-text\">accept_type</code>을 <code class=\"language-text\">offline</code>으로, <code class=\"language-text\">prompt</code>는 <code class=\"language-text\">consent</code>로 설정하여 매번 새롭게 Refresh Token을 받도록 세팅한다.</li>\n</ul>\n<h2>정리</h2>\n<p>영어를 번역기로 해석한 수준의 문장으로 인해 많은 시간을 삽질하게 되었다. 덕분에 Google에서 의도하는 Refresh Token에 대한 사용 방식과 어디에서 저장하고 관리해야 하는지에 대해 좀 더 깊은 고민을 할 수 있게 되었다. 만약 나와 같은 상황에 직면한 사람이 있다면 이 글이 도움이 되길 바란다!</p>\n<h2>References.</h2>\n<p><a href=\"https://github.com/woowacourse-teams/2022-dallog\">dallog repository</a><br>\n<a href=\"https://github.com/devHudi\">https://github.com/devHudi</a><br>\n<a href=\"https://m.blog.naver.com/dldbdgml99/222013891067\">passport.js에서 구글 OAuth 진행 시 Refresh Token을 못 받아오는 문제 해결</a><br></p>","frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다.","date":"August 22, 2022","update":"August 22, 2022","tags":["매트","BE","OAuth","OpenId","refresh token"],"series":null},"fields":{"slug":"/google-refresh-token/","readingTime":{"minutes":12.495}}},"seriesList":{"edges":[{"node":{"id":"a621dc7b-8590-5ec6-9b52-3d9e5182486d","fields":{"slug":"/appearance-background-of-jpa/"},"frontmatter":{"title":"JPA 등장배경"}}},{"node":{"id":"9d2a87b6-2b9c-5b87-b790-3426d17c2d8e","fields":{"slug":"/intellij-final-keyword/"},"frontmatter":{"title":"IntelliJ에서 메소드 추출한 메소드의 파라미터에 final 키워드 자동 추가하기"}}},{"node":{"id":"251e9767-1c92-5cf5-9cef-2c4a42c10df2","fields":{"slug":"/git-branch-strategy/"},"frontmatter":{"title":"달록팀의 git 브랜치 전략을 소개합니다."}}},{"node":{"id":"5090cce3-0c1f-5376-badc-1d25e44c1bd9","fields":{"slug":"/infinite-scroll/"},"frontmatter":{"title":"React에서 무한 스크롤 구현하기"}}},{"node":{"id":"bcb53ba5-0286-5d10-96c2-fdcb88e2cc60","fields":{"slug":"/package-structure/"},"frontmatter":{"title":"달록에 적절한 패키지 구조 고민하기"}}},{"node":{"id":"a7fc89de-f37c-596e-a81d-3d4fe5a795b8","fields":{"slug":"/data-jpa-slice-page/"},"frontmatter":{"title":"Spring Data JPA의 Slice & Page"}}},{"node":{"id":"e1ba92ee-0cf0-50c8-80bd-5da5075df8d1","fields":{"slug":"/data-jpa-auditing/"},"frontmatter":{"title":"Spring Data JPA의 Auditing"}}},{"node":{"id":"3e036508-c916-504e-9e8d-89f69332471e","fields":{"slug":"/separated-interface/"},"frontmatter":{"title":"외부와 의존성 분리하기"}}},{"node":{"id":"cade544a-16ef-58a3-b97c-824986a8395f","fields":{"slug":"/apply-rest-docs/"},"frontmatter":{"title":"MockMvc를 사용한 Spring RestDocs"}}},{"node":{"id":"87649d54-d59e-58a6-afd5-8491eb4113a8","fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}}},{"node":{"id":"eb380f6d-5a00-5a9e-a916-003fb292cc8a","fields":{"slug":"/test-fixture-constant/"},"frontmatter":{"title":"테스트에서 Entity 객체를 상수로 두면 안 되는 이유"}}},{"node":{"id":"9734e30a-b430-5922-919d-f53808a56eb9","fields":{"slug":"/what_is_nginx/"},"frontmatter":{"title":"NGINX 란?"}}},{"node":{"id":"9ebc6e21-2a76-5d42-be33-c2dae8c849b2","fields":{"slug":"/ssl_protocol/"},"frontmatter":{"title":"SSL을 통한 HTTPS통신 과정"}}},{"node":{"id":"fa5ad595-1f81-5a20-a884-2da69adee3c5","fields":{"slug":"/integration-test-slice-test/"},"frontmatter":{"title":"통합 테스트와 슬라이스 테스트"}}},{"node":{"id":"d8c66823-bb05-5e83-a6a1-2fd9af450b6f","fields":{"slug":"/query-invalidation/"},"frontmatter":{"title":"React-Query에서의 데이터 최신화 (Query Invalidation)"}}},{"node":{"id":"f5187517-342f-52a1-9092-d12c1a80d132","fields":{"slug":"/seperate-components/"},"frontmatter":{"title":"컴포넌트 분리 기준"}}},{"node":{"id":"d6249c8b-bea6-5c91-8477-d3dd15ad9b39","fields":{"slug":"/test-isolation/"},"frontmatter":{"title":"테스트 격리"}}},{"node":{"id":"98e390ef-fb19-5d01-a3ef-d14bc0e65176","fields":{"slug":"/dallog-jacoco/"},"frontmatter":{"title":"달록의 Jacoco 적용기 (feat. Gradle)"}}},{"node":{"id":"33d19946-de0c-5b41-bfa0-d7c3fd80f10b","fields":{"slug":"/google-refresh-token/"},"frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다."}}},{"node":{"id":"8168857d-a82c-5608-bd40-cea4b917d17d","fields":{"slug":"/submodule/"},"frontmatter":{"title":"달록 서브모듈 도입기"}}},{"node":{"id":"836fc724-7e2f-5c7a-a42b-c0cc9163167a","fields":{"slug":"/dallog-flyway/"},"frontmatter":{"title":"달록의 데이터베이스 마이그레이션을 위한 Flyway 적용기"}}},{"node":{"id":"7a3bde6d-746b-56fd-8d91-0d8059ebf1f8","fields":{"slug":"/json-property-json-naming/"},"frontmatter":{"title":"@JsonProperty, @JsonNaming"}}},{"node":{"id":"50673f5c-f835-5982-b70c-b77e5a352a2c","fields":{"slug":"/servlet-life-cycle/"},"frontmatter":{"title":"서블릿 생명주기와 직접만든 톰캣을 통한 의문점"}}},{"node":{"id":"61e7f4d1-7b3a-5968-bfe8-c3f6efb88748","fields":{"slug":"/preparing-for-performance-test/"},"frontmatter":{"title":"톰캣 튜닝을 위한 달록의 서버 성능 테스트 준비 과정"}}},{"node":{"id":"9272061d-68c6-5f82-a961-0e2efe0fd6be","fields":{"slug":"/cyclic-dependency/"},"frontmatter":{"title":"cyclic dependency"}}},{"node":{"id":"6e779308-f266-58af-bfcc-e9fee6d39a98","fields":{"slug":"/multi-datasource-issue-with-osiv/"},"frontmatter":{"title":"대체 왜 DataSource 라우팅이 안되는거야!? (feat. OSIV)"}}},{"node":{"id":"0e63245e-c52c-5977-9f60-f94ee0fd00fc","fields":{"slug":"/hikari-cp-theory/"},"frontmatter":{"title":"HikariCP와 적절한 풀 사이즈 고민하기 (이론편)"}}},{"node":{"id":"c7bea043-345c-5f78-ae53-796a83812961","fields":{"slug":"/react-query-useMutation-trouble-shooting/"},"frontmatter":{"title":"react-query useMutation onSuccess 안 되는줄 알았던 트러블 슈팅"}}},{"node":{"id":"cf403487-1c48-5ca7-b5c2-ef0d8fefe3c4","fields":{"slug":"/jenkins-distributed-build-architecture/"},"frontmatter":{"title":"젠킨스 분산 빌드 아키텍처 구축"}}},{"node":{"id":"24c152c7-4e94-5b84-aaea-a5a9a8357693","fields":{"slug":"/zero-downtime-deployment/"},"frontmatter":{"title":"달록 무중단 배포 도입기"}}}]},"previous":{"fields":{"slug":"/dallog-jacoco/"},"frontmatter":{"title":"달록의 Jacoco 적용기 (feat. Gradle)"}},"next":{"fields":{"slug":"/submodule/"},"frontmatter":{"title":"달록 서브모듈 도입기"}}},"pageContext":{"id":"33d19946-de0c-5b41-bfa0-d7c3fd80f10b","series":null,"previousPostId":"98e390ef-fb19-5d01-a3ef-d14bc0e65176","nextPostId":"8168857d-a82c-5608-bd40-cea4b917d17d"}},"staticQueryHashes":[]}